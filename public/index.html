<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>EventRate - Application Compl√®te</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="modern-styles.css" />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#eff6ff",
                100: "#dbeafe",
                200: "#bfdbfe",
                300: "#93c5fd",
                400: "#60a5fa",
                500: "#3b82f6",
                600: "#2563eb",
                700: "#1d4ed8",
                800: "#1e40af",
                900: "#1e3a8a",
              },
            },
          },
        },
      };
    </script>
  </head>
  <body>
    <!-- Navigation Moderne -->
    <nav class="nav-modern">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
          <div class="flex items-center">
            <div
              class="w-10 h-10 rounded-xl flex items-center justify-center mr-3"
              style="background: var(--primary-gradient)"
            >
              <span class="text-white font-bold text-lg">E</span>
            </div>
            <span class="text-xl font-bold text-gray-900">EventRate</span>
          </div>

          <!-- Navigation desktop -->
          <div class="hidden md:flex items-center space-x-4">
            <a
              href="#"
              class="text-gray-700 hover:text-gray-900 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:bg-gray-100"
              onclick="showSection('home')"
              >Accueil</a
            >
            <a
              href="#"
              class="text-gray-700 hover:text-gray-900 px-4 py-2 rounded-lg text-sm font-medium transition-all duration-300 hover:bg-gray-100"
              onclick="showSection('events')"
              >√âv√©nements</a
            >
            <button
              class="btn-gradient"
              onclick="handleCreateEvent()"
              id="create-event-btn"
            >
              ‚ú® Cr√©er un √©v√©nement
            </button>
            <button
              class="btn-gradient"
              onclick="showSection('register')"
              id="register-btn"
            >
              üöÄ S'inscrire
            </button>
            <button
              class="glass-card text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition-all duration-300"
              onclick="showSection('login')"
              id="login-btn"
            >
              üîë Se connecter
            </button>
            <button
              class="glass-card text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition-all duration-300"
              onclick="openMyRatingsModal()"
              id="my-ratings-btn"
              style="display: none"
            >
              ‚≠ê Mes avis
            </button>
            <button
              class="glass-card text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition-all duration-300"
              onclick="openMyEventsModal()"
              id="my-events-btn"
              style="display: none"
            >
              üé™ Mes √©v√©nements
            </button>
            <button
              class="glass-card text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-100 transition-all duration-300"
              onclick="logout()"
              id="logout-btn"
              style="display: none"
            >
              üö™ Se d√©connecter
            </button>
          </div>

          <!-- Bouton hamburger mobile -->
          <div class="md:hidden flex items-center">
            <button
              type="button"
              class="text-gray-700 hover:text-primary-600 focus:outline-none focus:text-primary-600"
              onclick="toggleMobileMenu()"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16M4 18h16"
                />
              </svg>
            </button>
          </div>
        </div>

        <!-- Menu mobile -->
        <div class="md:hidden hidden" id="mobile-menu">
          <div
            class="px-2 pt-2 pb-3 space-y-1 sm:px-3 bg-white border-t border-gray-200"
          >
            <a
              href="#"
              class="text-gray-700 hover:text-primary-600 block px-3 py-2 text-base font-medium"
              onclick="showSection('home'); toggleMobileMenu()"
              >Accueil</a
            >
            <a
              href="#"
              class="text-gray-700 hover:text-primary-600 block px-3 py-2 text-base font-medium"
              onclick="showSection('events'); toggleMobileMenu()"
              >√âv√©nements</a
            >
            <button
              class="w-full text-left text-gray-700 hover:text-primary-600 block px-3 py-2 text-base font-medium"
              onclick="handleCreateEvent(); toggleMobileMenu()"
            >
              Cr√©er un √©v√©nement
            </button>
            <button
              class="w-full text-left text-gray-700 hover:text-primary-600 block px-3 py-2 text-base font-medium"
              onclick="showSection('register'); toggleMobileMenu()"
              id="mobile-register-btn"
            >
              S'inscrire
            </button>
            <button
              class="w-full text-left text-gray-700 hover:text-primary-600 block px-3 py-2 text-base font-medium"
              onclick="showSection('login'); toggleMobileMenu()"
              id="mobile-login-btn"
            >
              Se connecter
            </button>
            <button
              class="w-full text-left text-gray-700 hover:text-primary-600 block px-3 py-2 text-base font-medium"
              onclick="openMyRatingsModal(); toggleMobileMenu()"
              id="mobile-my-ratings-btn"
              style="display: none"
            >
              Mes avis
            </button>
            <button
              class="w-full text-left text-gray-700 hover:text-primary-600 block px-3 py-2 text-base font-medium"
              onclick="openMyEventsModal(); toggleMobileMenu()"
              id="mobile-my-events-btn"
              style="display: none"
            >
              Mes √©v√©nements
            </button>
            <button
              class="w-full text-left text-gray-700 hover:text-primary-600 block px-3 py-2 text-base font-medium"
              onclick="logout(); toggleMobileMenu()"
              id="mobile-logout-btn"
              style="display: none"
            >
              Se d√©connecter
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Section Accueil -->
    <section id="home" class="section active">
      <!-- Hero Section Moderne -->
      <div class="relative min-h-screen flex items-center justify-center">
        <div
          class="absolute inset-0"
          style="background: var(--primary-gradient)"
        ></div>
        <div
          class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 text-center"
        >
          <div class="text-center">
            <h1
              class="text-5xl md:text-7xl font-bold mb-8 text-gray-900 animate-slide-up"
            >
              D√©couvrez et cr√©ez des
              <span
                class="block bg-gradient-to-r from-yellow-400 to-orange-400 bg-clip-text text-transparent"
                >√©v√©nements incroyables</span
              >
            </h1>
            <p
              class="text-xl md:text-2xl mb-12 text-gray-700 max-w-3xl mx-auto animate-fade-in"
            >
              La plateforme qui r√©volutionne la cr√©ation et la d√©couverte
              d'√©v√©nements. Notez, partagez et vivez des exp√©riences uniques.
            </p>
            <div
              class="flex flex-col sm:flex-row gap-6 justify-center animate-slide-up"
            >
              <button
                class="glass-card text-gray-700 px-8 py-4 rounded-2xl text-lg font-semibold inline-flex items-center hover:bg-gray-100 transition-all duration-300"
                onclick="showSection('events')"
              >
                üéØ D√©couvrir des √©v√©nements
                <svg
                  class="ml-2 h-5 w-5"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 7l5 5m0 0l-5 5m5-5H6"
                  ></path>
                </svg>
              </button>
              <button
                class="btn-gradient px-8 py-4 rounded-2xl text-lg font-semibold"
                onclick="showSection('register')"
              >
                üöÄ Commencer gratuitement
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Fonctionnalit√©s -->
      <div class="py-20 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              Pourquoi choisir EventRate ?
            </h2>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
              Une plateforme compl√®te pour tous vos besoins √©v√©nementiels
            </p>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
            <div class="text-center">
              <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary-500 text-white mb-6"
              >
                <svg
                  class="h-8 w-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                  ></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-3">
                Cr√©ez des √©v√©nements
              </h3>
              <p class="text-gray-600">
                Organisez vos propres √©v√©nements et g√©rez-les facilement
              </p>
            </div>

            <div class="text-center">
              <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-yellow-500 text-white mb-6"
              >
                <svg
                  class="h-8 w-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"
                  ></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-3">
                Notez et √©valuez
              </h3>
              <p class="text-gray-600">
                Donnez votre avis sur les √©v√©nements avec des crit√®res d√©taill√©s
              </p>
            </div>

            <div class="text-center">
              <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-500 text-white mb-6"
              >
                <svg
                  class="h-8 w-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"
                  ></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-3">
                Communaut√© active
              </h3>
              <p class="text-gray-600">
                Rejoignez une communaut√© passionn√©e d'√©v√©nements
              </p>
            </div>

            <div class="text-center">
              <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-500 text-white mb-6"
              >
                <svg
                  class="h-8 w-8"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
                  ></path>
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"
                  ></path>
                </svg>
              </div>
              <h3 class="text-xl font-semibold text-gray-900 mb-3">
                G√©olocalisation
              </h3>
              <p class="text-gray-600">
                Trouvez des √©v√©nements pr√®s de chez vous
              </p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section √âv√©nements -->
    <section id="events" class="section hidden">
      <div class="py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              √âv√©nements disponibles
            </h2>
            <p class="text-xl text-gray-600">
              D√©couvrez les √©v√©nements de la communaut√©
            </p>
          </div>

          <!-- Barre de filtrage et tri avanc√©e -->
          <div
            class="bg-white rounded-lg shadow-lg p-6 mb-8 border border-gray-200"
          >
            <!-- Barre de recherche principale -->
            <div class="mb-6">
              <div class="relative">
                <div
                  class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
                >
                  <svg
                    class="h-5 w-5 text-gray-400"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                    ></path>
                  </svg>
                </div>
                <input
                  type="text"
                  id="search-events"
                  placeholder="üîç Rechercher par nom d'√©v√©nement, lieu, organisateur..."
                  class="block w-full pl-10 pr-12 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 text-lg"
                  oninput="applyFilters()"
                />
                <button
                  type="button"
                  onclick="clearSearch()"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                  id="clear-search-btn"
                  style="display: none"
                >
                  <svg
                    class="h-5 w-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M6 18L18 6M6 6l12 12"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Filtres avanc√©s -->
            <div
              class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6"
            >
              <!-- Cat√©gorie -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >üè∑Ô∏è Cat√©gorie</label
                >
                <select
                  id="category-filter"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  onchange="applyFilters()"
                >
                  <option value="">Toutes</option>
                  <option value="business">üíº Business & Networking</option>
                  <option value="tech">üíª Technologie</option>
                  <option value="culture">üé® Culture & Arts</option>
                  <option value="sport">‚öΩ Sport & Fitness</option>
                  <option value="education">üìö √âducation</option>
                  <option value="social">üë• Social & Communaut√©</option>
                  <option value="music">üéµ Musique</option>
                  <option value="food">üçΩÔ∏è Gastronomie</option>
                </select>
              </div>

              <!-- Ville -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >üìç Ville</label
                >
                <select
                  id="city-filter"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  onchange="applyFilters()"
                >
                  <option value="">Toutes les villes</option>
                  <!-- Les villes seront ajout√©es dynamiquement -->
                </select>
              </div>

              <!-- Prix -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >üí∞ Prix</label
                >
                <select
                  id="price-filter"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  onchange="applyFilters()"
                >
                  <option value="">Tous les prix</option>
                  <option value="free">üÜì Gratuit</option>
                  <option value="0-10">üí∏ 0‚Ç¨ - 10‚Ç¨</option>
                  <option value="10-25">üíµ 10‚Ç¨ - 25‚Ç¨</option>
                  <option value="25-50">üí¥ 25‚Ç¨ - 50‚Ç¨</option>
                  <option value="50+">üíé Plus de 50‚Ç¨</option>
                </select>
              </div>

              <!-- Note minimum -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >‚≠ê Note min.</label
                >
                <select
                  id="rating-filter"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  onchange="applyFilters()"
                >
                  <option value="0">Toutes les notes</option>
                  <option value="2">‚≠ê‚≠ê 2+ √©toiles</option>
                  <option value="3">‚≠ê‚≠ê‚≠ê 3+ √©toiles</option>
                  <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4+ √©toiles</option>
                  <option value="4.5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 4.5+ √©toiles</option>
                </select>
              </div>

              <!-- Date -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >üìÖ P√©riode</label
                >
                <select
                  id="date-filter"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  onchange="applyFilters()"
                >
                  <option value="">Toutes les dates</option>
                  <option value="today">üåÖ Aujourd'hui</option>
                  <option value="tomorrow">üåÑ Demain</option>
                  <option value="this-week">üìÜ Cette semaine</option>
                  <option value="next-week">üìÖ Semaine prochaine</option>
                  <option value="this-month">üóìÔ∏è Ce mois-ci</option>
                  <option value="next-month">üìã Mois prochain</option>
                </select>
              </div>
            </div>

            <!-- Tri et actions -->
            <div
              class="flex flex-wrap items-center justify-between border-t pt-4"
            >
              <div class="flex items-center space-x-4 mb-4 lg:mb-0">
                <label class="text-sm font-medium text-gray-700"
                  >üìä Trier par :</label
                >
                <select
                  id="sort-select"
                  class="px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                  onchange="applyFilters()"
                >
                  <option value="date-asc">üìÖ Date (plus proche)</option>
                  <option value="date-desc">üìÖ Date (plus lointaine)</option>
                  <option value="price-asc">üí∞ Prix (croissant)</option>
                  <option value="price-desc">üí∞ Prix (d√©croissant)</option>
                  <option value="title-asc">üî§ Titre (A-Z)</option>
                  <option value="title-desc">üî§ Titre (Z-A)</option>
                  <option value="rating-desc">‚≠ê Mieux not√©s</option>
                  <option value="popularity-desc">üî• Plus populaires</option>
                  <option value="recent-desc">üÜï R√©cemment ajout√©s</option>
                </select>
              </div>

              <div class="flex items-center space-x-3">
                <div class="flex items-center space-x-2">
                  <span class="text-sm text-gray-500">Affichage :</span>
                  <button
                    id="grid-view-btn"
                    onclick="setViewMode('grid')"
                    class="p-2 text-gray-500 hover:text-primary-600 border rounded transition-colors view-toggle active"
                    title="Vue grille"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"
                      ></path>
                    </svg>
                  </button>
                  <button
                    id="list-view-btn"
                    onclick="setViewMode('list')"
                    class="p-2 text-gray-500 hover:text-primary-600 border rounded transition-colors view-toggle"
                    title="Vue liste"
                  >
                    <svg
                      class="w-4 h-4"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                        clip-rule="evenodd"
                      ></path>
                    </svg>
                  </button>
                </div>
                <div class="flex flex-col sm:flex-row items-center gap-2">
                <button
                  type="button"
                  onclick="resetFilters()"
                    class="px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors whitespace-nowrap"
                >
                  üóëÔ∏è Effacer filtres
                </button>
                <span
                  id="events-count"
                    class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full whitespace-nowrap"
                >
                  0 √©v√©nement(s)
                </span>
                </div>
              </div>
            </div>
          </div>

          <div
            class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
            id="events-container"
          >
            <!-- Les √©v√©nements seront charg√©s ici -->
          </div>

          <!-- Message si aucun √©v√©nement trouv√© -->
          <div id="no-events-found" class="hidden text-center py-16">
            <div class="text-gray-300 text-8xl mb-6">üîç</div>
            <h3 class="text-2xl font-semibold text-gray-600 mb-3">
              Aucun √©v√©nement trouv√©
            </h3>
            <p class="text-gray-500 mb-6">
              Essayez de modifier vos crit√®res de recherche ou filtres.
            </p>
            <button
              onclick="resetFilters()"
              class="px-6 py-3 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors"
            >
              üóëÔ∏è R√©initialiser tous les filtres
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Section Cr√©er un √©v√©nement -->
    <section id="create-event" class="section hidden">
      <div class="py-20 bg-white">
        <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              Cr√©er un nouvel √©v√©nement
            </h2>
            <p class="text-xl text-gray-600">
              Partagez votre √©v√©nement avec la communaut√©
            </p>
          </div>

          <form
            id="create-event-form"
            class="space-y-6"
            onsubmit="createNewEvent(event)"
          >
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Titre de l'√©v√©nement</label
              >
              <input
                type="text"
                id="event-title"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                oninput="checkDuplicatesRealTime()"
                placeholder="Entrez le titre de votre √©v√©nement..."
              />
              <!-- Conteneur pour les suggestions de doublons -->
              <div
                id="duplicate-suggestions"
                class="hidden mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded-md"
              >
                <div class="flex items-start">
                  <div class="flex-shrink-0">
                    <svg
                      class="h-5 w-5 text-yellow-400"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                        clip-rule="evenodd"
                      ></path>
                    </svg>
                  </div>
                  <div class="ml-3">
                    <h3 class="text-sm font-medium text-yellow-800">
                      √âv√©nements similaires trouv√©s
                    </h3>
                    <div
                      id="duplicate-list"
                      class="mt-2 text-sm text-yellow-700"
                    >
                      <!-- Les suggestions appara√Ætront ici -->
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Description</label
              >
              <textarea
                id="event-description"
                rows="4"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
              ></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Cat√©gorie</label
                >
                <select
                  id="event-category"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                >
                  <option value="">S√©lectionner</option>
                  <option value="music">Musique</option>
                  <option value="business">Business</option>
                  <option value="sport">Sport</option>
                  <option value="culture">Culture</option>
                  <option value="food">Gastronomie</option>
                  <option value="tech">Technologie</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Ville</label
                >
                <input
                  type="text"
                  id="event-city"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Adresse</label
                >
                <input
                  type="text"
                  id="event-address"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
              </div>
            </div>

            <!-- URLs des photos -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Photos de l'√©v√©nement</label
              >
              <div class="space-y-3">
                <div>
                  <label class="block text-sm text-gray-600 mb-1"
                    >Lien de l'affiche/photo principale</label
                  >
                  <input
                    type="url"
                    id="event-photo-url-1"
                    name="event-photo-url-1"
                    placeholder="https://exemple.com/mon-affiche.jpg"
                    class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    onchange="previewImageUrl(this, 1)"
                  />
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1"
                    >Lien photo 2 (optionnel)</label
                  >
                  <input
                    type="url"
                    id="event-photo-url-2"
                    name="event-photo-url-2"
                    placeholder="https://exemple.com/photo2.jpg"
                    class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    onchange="previewImageUrl(this, 2)"
                  />
                </div>
                <div>
                  <label class="block text-sm text-gray-600 mb-1"
                    >Lien photo 3 (optionnel)</label
                  >
                  <input
                    type="url"
                    id="event-photo-url-3"
                    name="event-photo-url-3"
                    placeholder="https://exemple.com/photo3.jpg"
                    class="block w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                    onchange="previewImageUrl(this, 3)"
                  />
                </div>
              </div>
              <!-- Pr√©visualisation des photos -->
              <div
                id="photo-preview"
                class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 hidden"
              ></div>
              <p class="text-xs text-gray-500 mt-2">
                üí° Astuce : Vous pouvez copier le lien d'une image depuis
                Instagram, Facebook, votre site web, etc.
              </p>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Date de d√©but</label
                >
                <input
                  type="datetime-local"
                  id="event-start"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Date de fin</label
                >
                <input
                  type="datetime-local"
                  id="event-end"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Prix (‚Ç¨)</label
                >
                <input
                  type="number"
                  id="event-price"
                  min="0"
                  step="0.01"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
              </div>
              <div class="flex items-center mt-6">
                <input
                  type="checkbox"
                  id="event-free"
                  class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                />
                <label for="event-free" class="ml-2 block text-sm text-gray-900"
                  >√âv√©nement gratuit</label
                >
              </div>
            </div>

            <div class="flex gap-4">
              <button
                type="submit"
                class="flex-1 bg-primary-600 text-white py-3 px-4 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500"
              >
                Cr√©er l'√©v√©nement
              </button>
              <button
                type="button"
                onclick="showSection('home')"
                class="px-4 py-3 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
              >
                Annuler
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Section R√©initialisation de mot de passe -->
    <section id="reset-password-section" class="section hidden">
      <div class="py-20 bg-white">
        <div class="max-w-md mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">
              Nouveau mot de passe
            </h2>
            <p class="text-gray-600">Entrez votre nouveau mot de passe</p>
          </div>

          <form class="space-y-6" onsubmit="resetPassword(event)">
            <div>
              <label
                for="reset-token"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Token de r√©initialisation</label
              >
              <input
                type="text"
                id="reset-token"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                placeholder="Token re√ßu par email"
              />
            </div>
            <div>
              <label
                for="reset-password"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Nouveau mot de passe</label
              >
              <div class="relative">
                <input
                  type="password"
                  id="reset-password"
                  required
                  minlength="6"
                  class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('reset-password', 'reset-password-toggle')"
                  id="reset-password-toggle"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    ></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label
                for="reset-password-confirm"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Confirmer le mot de passe</label
              >
              <div class="relative">
                <input
                  type="password"
                  id="reset-password-confirm"
                  required
                  minlength="6"
                  class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('reset-password-confirm', 'reset-password-confirm-toggle')"
                  id="reset-password-confirm-toggle"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    ></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <button
              type="submit"
              class="w-full bg-primary-600 text-white py-3 px-4 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500"
            >
              R√©initialiser le mot de passe
            </button>
          </form>
          <div class="mt-6 text-center">
            <p class="text-gray-600">
              Retour √† la
              <button
                onclick="showSection('login')"
                class="text-primary-600 hover:text-primary-800 font-semibold"
              >
                connexion
              </button>
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Section Connexion -->
    <section id="login" class="section hidden">
      <div class="py-20 bg-white">
        <div class="max-w-md mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">Se connecter</h2>
            <p class="text-gray-600">Acc√©dez √† votre compte EventRate</p>
          </div>

          <form class="space-y-6" onsubmit="login(event)">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="login-email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Mot de passe</label
              >
              <div class="relative">
              <input
                type="password"
                id="login-password"
                required
                  class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('login-password', 'login-password-toggle')"
                  id="login-password-toggle"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    ></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>

            <!-- Option "Se souvenir de moi" -->
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <input
                  id="remember-me-login"
                  type="checkbox"
                  class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                />
                <label
                  for="remember-me-login"
                  class="ml-2 block text-sm text-gray-700"
                >
                  Se souvenir de moi
                </label>
              </div>
              <button
                type="button"
                onclick="showRecoveryCodeSection()"
                class="text-sm text-blue-600 hover:text-blue-800 font-medium"
              >
                Mot de passe oubli√© ?
              </button>
            </div>

            <button
              type="submit"
              class="w-full bg-primary-600 text-white py-3 px-4 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500"
            >
              Se connecter
            </button>

            <div class="text-center">
              <p class="text-sm text-gray-600">
                Pas encore de compte ?
                <a
                  href="#"
                  onclick="showSection('register')"
                  class="text-primary-600 hover:text-primary-500"
                  >S'inscrire</a
                >
              </p>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Section Inscription -->
    <section id="register" class="section hidden">
      <div class="py-20 bg-white">
        <div class="max-w-md mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">
              Cr√©er un compte
            </h2>
            <p class="text-gray-600">Rejoignez la communaut√© EventRate</p>
          </div>

          <form class="space-y-6" onsubmit="register(event)">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Pr√©nom</label
                >
                <input
                  type="text"
                  id="register-firstname"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Nom</label
                >
                <input
                  type="text"
                  id="register-lastname"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Nom d'utilisateur</label
              >
              <input
                type="text"
                id="register-username"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="register-email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Mot de passe</label
              >
              <div class="relative">
              <input
                type="password"
                id="register-password"
                required
                  class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('register-password', 'register-password-toggle')"
                  id="register-password-toggle"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    ></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Code de r√©cup√©ration</label
              >
              <input
                type="text"
                id="register-recovery-code"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white font-mono"
                placeholder="Votre code secret (ex: RC-ABC123-XYZ789)"
              />
              <p class="text-xs text-gray-500 mt-1">
                ‚ö†Ô∏è <strong>GARDEZ CE CODE PR√âCIEUSEMENT !</strong> Il vous
                servira √† r√©initialiser votre mot de passe si vous l'oubliez.
              </p>
            </div>

            <!-- Option "Se souvenir de moi" -->
            <div class="flex items-center justify-between">
              <div class="flex items-center">
                <input
                  id="remember-me-register"
                  type="checkbox"
                  class="h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"
                />
                <label
                  for="remember-me-register"
                  class="ml-2 block text-sm text-gray-700"
                >
                  Se souvenir de moi
                </label>
              </div>
              <div class="text-sm">
                <span class="text-gray-500">√âvite de re-saisir vos infos</span>
              </div>
            </div>

            <button
              type="submit"
              class="w-full bg-primary-600 text-white py-3 px-4 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500"
            >
              Cr√©er mon compte
            </button>

            <div class="text-center">
              <p class="text-sm text-gray-600">
                D√©j√† un compte ?
                <a
                  href="#"
                  onclick="showSection('login')"
                  class="text-primary-600 hover:text-primary-500"
                  >Se connecter</a
                >
              </p>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Section R√©initialisation avec code de r√©cup√©ration -->
    <section id="recovery-code-section" class="section hidden">
      <div class="py-20 bg-white">
        <div class="max-w-md mx-auto px-4 sm:px-6 lg:px-8">
          <div class="text-center mb-16">
            <h2 class="text-3xl font-bold text-gray-900 mb-4">
              üîë R√©initialisation de mot de passe
            </h2>
            <p class="text-gray-600">
              Entrez votre email et votre code de r√©cup√©ration
            </p>
          </div>

          <form
            class="space-y-6"
            onsubmit="resetPasswordWithRecoveryCode(event)"
          >
            <div>
              <label
                for="recovery-email"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Email</label
              >
              <input
                type="email"
                id="recovery-email"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                placeholder="votre@email.com"
              />
            </div>
            <div>
              <label
                for="recovery-code"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Code de r√©cup√©ration</label
              >
              <input
                type="text"
                id="recovery-code"
                required
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white font-mono"
                placeholder="Votre code secret"
              />
              <p class="text-xs text-gray-500 mt-1">
                Le code que vous avez d√©fini lors de votre inscription
              </p>
            </div>
            <div>
              <label
                for="new-password"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Nouveau mot de passe</label
              >
              <div class="relative">
                <input
                  type="password"
                  id="new-password"
                  required
                  minlength="6"
                  class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('new-password', 'new-password-toggle')"
                  id="new-password-toggle"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    ></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <div>
              <label
                for="confirm-new-password"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Confirmer le nouveau mot de passe</label
              >
              <div class="relative">
                <input
                  type="password"
                  id="confirm-new-password"
                  required
                  minlength="6"
                  class="w-full px-3 py-2 pr-10 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                />
                <button
                  type="button"
                  onclick="togglePasswordVisibility('confirm-new-password', 'confirm-new-password-toggle')"
                  id="confirm-new-password-toggle"
                  class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600"
                >
                  <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                    ></path>
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                    ></path>
                  </svg>
                </button>
              </div>
            </div>
            <button
              type="submit"
              class="w-full bg-primary-600 text-white py-3 px-4 rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500"
            >
              R√©initialiser le mot de passe
            </button>
          </form>

          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600">
              Vous vous souvenez de votre mot de passe ?
              <button
                onclick="showSection('login')"
                class="text-primary-600 hover:text-primary-500 font-medium"
              >
                Se connecter
              </button>
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Modal de notification -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
      <div
        class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm"
      >
        <div class="flex items-center">
          <div id="notification-icon" class="flex-shrink-0 mr-3">
            <!-- Icon sera ajout√© dynamiquement -->
          </div>
          <div>
            <h3
              id="notification-title"
              class="text-sm font-medium text-gray-900"
            ></h3>
            <p id="notification-message" class="text-sm text-gray-500"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de notation d√©taill√©e -->
    <div
      id="rating-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
      onclick="closeRatingModal()"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto"
          id="rating-modal-content"
        >
          <!-- Header -->
          <div class="flex items-center justify-between p-6 border-b" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-900" ondblclick="closeRatingModal()">
              Noter cet √©v√©nement
            </h2>
            <button
              onclick="closeRatingModal(); event.stopPropagation();"
              class="text-gray-400 hover:text-gray-600"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <!-- Contenu -->
          <div class="p-6" onclick="event.stopPropagation()">
            <form
              id="detailed-rating-form"
              onsubmit="submitDetailedRating(event)"
            >
              <input type="hidden" id="rating-event-id" />

              <!-- Informations de pr√©sence -->
              <div class="mb-8 bg-blue-50 p-6 rounded-lg">
                <h3
                  class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
                >
                  <svg
                    class="w-5 h-5 mr-2 text-blue-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    ></path>
                  </svg>
                  Votre pr√©sence √† l'√©v√©nement
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Heure d'arriv√©e</label
                    >
                    <input
                      type="time"
                      id="arrival-time"
                      class="block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                      required
                    />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Heure de d√©part</label
                    >
                    <div class="flex items-center space-x-3">
                      <input
                        type="time"
                        id="departure-time"
                        class="block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500"
                      />
                      <label class="flex items-center">
                        <input
                          type="checkbox"
                          id="still-present"
                          class="mr-2"
                          onchange="toggleDepartureTime()"
                        />
                        <span class="text-sm text-gray-600"
                          >Encore pr√©sent</span
                        >
                      </label>
                    </div>
                  </div>
                  <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Ou s√©lectionnez votre moment de pr√©sence</label
                    >
                    <div class="flex flex-wrap gap-2">
                      <button
                        type="button"
                        class="time-period-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-50"
                        data-period="debut"
                      >
                        D√©but d'√©v√©nement
                      </button>
                      <button
                        type="button"
                        class="time-period-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-50"
                        data-period="milieu"
                      >
                        Milieu d'√©v√©nement
                      </button>
                      <button
                        type="button"
                        class="time-period-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-50"
                        data-period="fin"
                      >
                        Fin d'√©v√©nement
                      </button>
                      <button
                        type="button"
                        class="time-period-btn px-3 py-2 border rounded-md text-sm hover:bg-gray-50"
                        data-period="complet"
                      >
                        √âv√©nement complet
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- √âvaluation rapide -->
              <div class="mb-8 bg-yellow-50 p-6 rounded-lg">
                <h3
                  class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
                >
                  <svg
                    class="w-5 h-5 mr-2 text-yellow-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.915a1 1 0 00.95-.69l1.519-4.674z"
                    ></path>
                  </svg>
                  Note globale
                </h3>
                <div class="mb-4">
                  <div class="flex items-center space-x-2">
                    <input
                      type="range"
                      id="overall-rating"
                      min="1"
                      max="5"
                      step="0.5"
                      value="3"
                      class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                      required
                      oninput="updateRatingValue('overall-rating')"
                    />
                    <span
                      id="overall-rating-value"
                      class="text-2xl font-bold text-yellow-600 min-w-[3rem]"
                      >3.0</span
                    >
                  </div>
                </div>

                <!-- Tags rapides -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 mb-2"
                    >Tags rapides (optionnel)</label
                  >
                  <div class="flex flex-wrap gap-2">
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="excellent"
                    >
                      üòç Excellent
                    </button>
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="bond√©"
                    >
                      üë• Tr√®s bond√©
                    </button>
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="calme"
                    >
                      üòå Ambiance calme
                    </button>
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="bruyant"
                    >
                      üîä Trop bruyant
                    </button>
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="famille"
                    >
                      üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Parfait famille
                    </button>
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="cher"
                    >
                      üí∏ Trop cher
                    </button>
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="bon-prix"
                    >
                      üí∞ Bon rapport qualit√©/prix
                    </button>
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="mal-organis√©"
                    >
                      ü§∑‚Äç‚ôÇÔ∏è Mal organis√©
                    </button>
                    <button
                      type="button"
                      class="tag-btn px-3 py-1 border rounded-full text-sm hover:bg-gray-50"
                      data-tag="bien-organis√©"
                    >
                      ‚úÖ Bien organis√©
                    </button>
                  </div>
                  <input type="hidden" id="selected-tags" value="" />
                </div>
              </div>

              <!-- Crit√®res d√©taill√©s (optionnels) -->
              <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                  <h3
                    class="text-lg font-semibold text-gray-900 flex items-center"
                  >
                    <svg
                      class="w-5 h-5 mr-2 text-blue-600"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                      ></path>
                    </svg>
                    √âvaluation d√©taill√©e
                  </h3>
                  <button
                    type="button"
                    id="toggle-detailed"
                    class="text-sm text-blue-600 hover:text-blue-800"
                    onclick="toggleDetailedCriteria()"
                  >
                    Afficher les crit√®res d√©taill√©s
                  </button>
                </div>

                <div id="detailed-criteria" class="hidden">
                  <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <p class="text-sm text-gray-600 mb-3">
                      üí° <strong>S√©lection libre :</strong> Cochez simplement
                      les crit√®res que vous souhaitez √©valuer
                    </p>
                  </div>

                  <!-- Grille de tous les crit√®res disponibles -->
                  <div
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"
                    id="all-criteria-container"
                  >
                    <!-- Les crit√®res seront ajout√©s ici -->
                  </div>
                </div>
              </div>

              <!-- Contexte et ambiance -->
              <div class="mb-8 bg-green-50 p-6 rounded-lg">
                <h3
                  class="text-lg font-semibold text-gray-900 mb-4 flex items-center"
                >
                  <svg
                    class="w-5 h-5 mr-2 text-green-600"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-1l-4 4z"
                    ></path>
                  </svg>
                  Contexte de votre visite
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Niveau d'affluence √† votre arriv√©e</label
                    >
                    <div class="flex items-center space-x-2">
                      <span class="text-sm text-gray-500">Vide</span>
                      <input
                        type="range"
                        id="crowd-level"
                        min="1"
                        max="5"
                        step="1"
                        value="3"
                        class="flex-1"
                        oninput="updateCrowdLevel()"
                      />
                      <span class="text-sm text-gray-500">Bond√©</span>
                    </div>
                    <div class="text-center mt-1">
                      <span
                        id="crowd-level-text"
                        class="text-sm font-medium text-gray-700"
                        >Mod√©r√©</span
                      >
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2"
                      >Conditions m√©t√©o (si pertinent)</label
                    >
                    <select
                      id="weather-conditions"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md"
                    >
                      <option value="">Non pertinent</option>
                      <option value="ensoleill√©">‚òÄÔ∏è Ensoleill√©</option>
                      <option value="nuageux">‚òÅÔ∏è Nuageux</option>
                      <option value="pluvieux">üåßÔ∏è Pluvieux</option>
                      <option value="neigeux">‚ùÑÔ∏è Neigeux</option>
                      <option value="venteux">üí® Venteux</option>
                      <option value="orageux">‚õàÔ∏è Orageux</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Commentaire -->
              <div class="mb-8">
                <label class="block text-sm font-medium text-gray-700 mb-2"
                  >Commentaire (optionnel)</label
                >
                <textarea
                  id="rating-comment"
                  rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md text-gray-900 bg-white"
                  placeholder="Partagez votre exp√©rience..."
                ></textarea>
              </div>

              <!-- Boutons -->
              <div class="flex justify-end space-x-4">
                <button
                  type="button"
                  onclick="closeRatingModal(); event.stopPropagation();"
                  class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
                >
                  Annuler
                </button>
                <button
                  type="submit"
                  class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700"
                >
                  Envoyer ma notation
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de comparaison des doublons -->
    <div
      id="duplicate-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-screen overflow-y-auto"
        >
          <!-- Header -->
          <div class="flex items-center justify-between p-6 border-b">
            <h2 class="text-2xl font-bold text-gray-900">
              Comparaison d'√©v√©nements similaires
            </h2>
            <button
              onclick="closeDuplicateModal()"
              class="text-gray-400 hover:text-gray-600"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <!-- Contenu -->
          <div class="p-6">
            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                Votre nouvel √©v√©nement
              </h3>
              <div id="new-event-details" class="bg-gray-50 p-4 rounded-lg">
                <!-- D√©tails du nouvel √©v√©nement -->
              </div>
            </div>

            <div class="mb-6">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">
                √âv√©nements similaires trouv√©s
              </h3>
              <div id="similar-events-list" class="space-y-4">
                <!-- Liste des √©v√©nements similaires -->
              </div>
            </div>

            <!-- Boutons -->
            <div class="flex justify-end space-x-4">
              <button
                onclick="closeDuplicateModal()"
                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
              >
                Annuler
              </button>
              <button
                onclick="confirmCreateEvent()"
                class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700"
              >
                Cr√©er quand m√™me
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal pour afficher les avis d'un √©v√©nement -->
    <div
      id="ratings-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
      onclick="closeRatingsModal()"
    >
        <div
        class="flex items-center justify-center min-h-screen p-4"
        >
        <div class="modal-glass max-w-4xl w-full max-h-screen overflow-y-auto" id="ratings-modal-content">
          <!-- Header -->
          <div class="flex items-center justify-between p-6 border-b" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-900" ondblclick="closeRatingsModal()">
              ‚≠ê Avis des participants
            </h2>
            <button
              onclick="closeRatingsModal(); event.stopPropagation();"
              class="text-gray-600 hover:text-gray-800 transition-colors"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <!-- Contenu -->
          <div class="p-6" onclick="event.stopPropagation()">
            <div id="ratings-content">
              <!-- Les avis seront charg√©s ici -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal d'√©dition d'√©v√©nement -->
    <div
      id="edit-event-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
      onclick="closeEditEventModal()"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div
          class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto"
          id="edit-event-modal-content"
        >
          <!-- Header -->
          <div class="flex items-center justify-between p-6 border-b" onclick="event.stopPropagation()">
            <h2 class="text-2xl font-bold text-gray-900" ondblclick="closeEditEventModal()">
              ‚úèÔ∏è Modifier l'√©v√©nement
            </h2>
            <button
              onclick="closeEditEventModal(); event.stopPropagation();"
              class="text-gray-400 hover:text-gray-600"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
          <!-- Formulaire d'√©dition -->
          <div class="p-6" onclick="event.stopPropagation()">
            <form id="edit-event-form" class="space-y-6">
              <!-- Titre -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  üìù Titre de l'√©v√©nement
                </label>
                <input
                  type="text"
                  id="edit-event-title"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                />
              </div>

              <!-- Description -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  üìÑ Description
                </label>
                <textarea
                  id="edit-event-description"
                  rows="4"
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                ></textarea>
              </div>

              <!-- Cat√©gorie -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  üè∑Ô∏è Cat√©gorie
                </label>
                <select
                  id="edit-event-category"
                  required
                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                >
                  <option value="">S√©lectionnez une cat√©gorie</option>
                  <option value="business">Business & Networking</option>
                  <option value="tech">Technologie</option>
                  <option value="culture">Culture & Arts</option>
                  <option value="sport">Sport & Fitness</option>
                  <option value="education">√âducation</option>
                  <option value="social">Social & Communaut√©</option>
                </select>
              </div>

              <!-- Lieu -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    üìç Adresse
                  </label>
                  <input
                    type="text"
                    id="edit-event-address"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    üèôÔ∏è Ville
                  </label>
                  <input
                    type="text"
                    id="edit-event-city"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                  />
                </div>
              </div>

              <!-- Dates -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    üìÖ Date de d√©but
                  </label>
                  <input
                    type="datetime-local"
                    id="edit-event-start-date"
                    required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                  />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    üìÖ Date de fin
                  </label>
                  <input
                    type="datetime-local"
                    id="edit-event-end-date"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                  />
                </div>
              </div>

              <!-- Prix -->
              <div class="grid grid-cols-1 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    üí∞ Prix (‚Ç¨)
                  </label>
                  <div class="space-y-2">
                    <input
                      type="number"
                      id="edit-event-price"
                      min="0"
                      step="0.01"
                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 bg-white"
                    />
                    <label class="flex items-center">
                      <input
                        type="checkbox"
                        id="edit-event-free"
                        class="mr-2"
                      />
                      <span class="text-sm text-gray-600"
                        >√âv√©nement gratuit</span
                      >
                    </label>
                  </div>
                </div>
              </div>

              <!-- Photos -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  üì∑ Photos de l'√©v√©nement
                </label>
                <div class="space-y-4">
                  <div id="edit-event-photos-container">
                    <!-- Les photos existantes seront charg√©es ici -->
                  </div>
                  <div class="flex items-center space-x-2">
                    <input
                      type="url"
                      id="edit-new-photo-url"
                      placeholder="https://exemple.com/photo.jpg"
                      class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500"
                    />
                    <button
                      type="button"
                      onclick="addEditPhoto()"
                      class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700"
                    >
                      ‚ûï Ajouter
                    </button>
                  </div>
                </div>
              </div>

              <!-- Boutons d'action -->
              <div class="flex justify-end space-x-4 pt-6 border-t">
                <button
                  type="button"
                  onclick="closeEditEventModal()"
                  class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50"
                >
                  Annuler
                </button>
                <button
                  type="submit"
                  class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                >
                  üíæ Sauvegarder
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal "Mes √©v√©nements" -->
    <div
      id="my-events-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
      onclick="closeMyEventsModal()"
    >
      <div
        class="flex items-center justify-center min-h-screen p-2 sm:p-4"
      >
        <div
          class="modal-glass max-w-6xl w-full max-h-screen overflow-y-auto mx-2 sm:mx-0"
          onclick="event.stopPropagation()"
        >
          <!-- Header -->
          <div class="flex items-center justify-between p-4 sm:p-6 border-b">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900">
              üé™ Mes √©v√©nements
            </h2>
            <button
              onclick="closeMyEventsModal()"
              class="text-gray-600 hover:text-gray-800 transition-colors"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>
          <!-- Contenu -->
          <div class="p-4 sm:p-6">
            <div id="my-events-list" class="space-y-4 sm:space-y-6">
              <!-- Les √©v√©nements de l'utilisateur seront charg√©s ici -->
              <p class="text-gray-500">Chargement de vos √©v√©nements...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal "Mes avis" -->
    <div
      id="my-ratings-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
      onclick="closeMyRatingsModal()"
    >
      <div
        class="flex items-center justify-center min-h-screen p-2 sm:p-4"
      >
        <div
          class="modal-glass max-w-5xl w-full max-h-screen overflow-y-auto mx-2 sm:mx-0"
          onclick="event.stopPropagation()"
        >
          <!-- Header -->
          <div class="flex items-center justify-between p-4 sm:p-6 border-b">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900">
              ‚≠ê Mes avis
            </h2>
            <button
              onclick="closeMyRatingsModal()"
              class="text-gray-600 hover:text-gray-800 transition-colors"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <!-- Contenu -->
          <div class="p-4 sm:p-6">
            <div id="my-ratings-content">
              <!-- Les avis de l'utilisateur seront charg√©s ici -->
              <div class="flex items-center justify-center py-8">
                <div class="text-center">
                  <div
                    class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600 mx-auto mb-4"
                  ></div>
                  <p class="text-gray-500">Chargement de vos avis...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de r√©cup√©ration de mot de passe -->
    <div
      id="forgot-password-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
      onclick="closeForgotPasswordModal()"
    >
      <div
        class="flex items-center justify-center min-h-screen p-2 sm:p-4"
        onclick="event.stopPropagation()"
      >
        <div class="modal-glass max-w-md w-full mx-2 sm:mx-0">
          <!-- Header -->
          <div class="flex items-center justify-between p-4 sm:p-6 border-b">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900">
              üîë Mot de passe oubli√©
            </h2>
            <button
              onclick="closeForgotPasswordModal()"
              class="text-gray-600 hover:text-gray-800 transition-colors"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                ></path>
              </svg>
            </button>
          </div>

          <!-- Contenu -->
          <div class="p-4 sm:p-6">
            <div class="text-center mb-6">
              <p class="text-gray-600 mb-4">
                Entrez votre adresse email et nous vous enverrons un lien pour
                r√©initialiser votre mot de passe.
              </p>
            </div>

            <form
              id="forgot-password-form"
              onsubmit="handleForgotPassword(event)"
              class="space-y-4"
            >
              <div>
                <label
                  for="forgot-email"
                  class="block text-sm font-medium text-gray-700 mb-2"
                >
                  Adresse email
                </label>
                <input
                  type="email"
                  id="forgot-email"
                  required
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-900 bg-white"
                  placeholder="votre@email.com"
                />
              </div>

              <button
                type="submit"
                class="w-full btn-gradient text-white py-3 px-6 rounded-lg font-semibold hover:shadow-lg transition-all duration-300"
              >
                Envoyer le lien de r√©initialisation
              </button>
            </form>

            <div class="mt-6 text-center">
              <button
                onclick="closeForgotPasswordModal(); showSection('login')"
                class="text-sm text-blue-600 hover:text-blue-800 font-medium"
              >
                ‚Üê Retour √† la connexion
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de connexion pour noter -->
    <div
      id="login-to-rate-modal"
      class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden"
    >
      <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
          <div class="text-center">
            <!-- Ic√¥ne -->
            <div
              class="w-16 h-16 mx-auto mb-4 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-full flex items-center justify-center"
            >
              <svg
                class="w-8 h-8 text-yellow-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                ></path>
              </svg>
            </div>

            <!-- Titre -->
            <h2 class="text-2xl font-bold text-gray-900 mb-2">
              Connexion requise
            </h2>

            <!-- Message -->
            <p class="text-gray-600 mb-6">
              Vous devez √™tre connect√© pour noter cet √©v√©nement. Connectez-vous
              ou cr√©ez un compte pour partager votre avis !
            </p>

            <!-- Boutons -->
            <div class="flex flex-col sm:flex-row gap-3">
              <button
                onclick="closeLoginToRateModal(); showSection('login')"
                class="btn-gradient flex-1 py-3 px-6 rounded-lg font-semibold text-white hover:shadow-lg transition-all duration-300"
              >
                üîê Se connecter
              </button>
              <button
                onclick="closeLoginToRateModal(); showSection('register')"
                class="glass-card flex-1 py-3 px-6 rounded-lg font-semibold text-gray-700 hover:bg-gray-100 transition-all duration-300"
              >
                ‚ú® Cr√©er un compte
              </button>
            </div>

            <!-- Bouton fermer -->
            <button
              onclick="closeLoginToRateModal()"
              class="mt-4 text-gray-400 hover:text-gray-600 transition-colors"
            >
              Annuler
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Variables globales
      let currentUser = null;
      let authToken = localStorage.getItem("authToken");

      // Gestion de la d√©connexion automatique (10 minutes)
      let inactivityTimer;
      let lastActivity = Date.now();
      const INACTIVITY_TIMEOUT = 10 * 60 * 1000; // 10 minutes en millisecondes

      // Configuration API
      // D√©tection automatique de l'environnement
      const API_BASE =
        window.location.hostname === "localhost"
          ? "http://localhost:5001/api"
          : window.location.origin + "/api";

      // Utilisation de l'API normale partout
      const EVENTS_ENDPOINT = API_BASE + "/events";

      // Fonctions de gestion de l'inactivit√©
      function resetInactivityTimer() {
        lastActivity = Date.now();
        clearTimeout(inactivityTimer);

        if (authToken) {
          inactivityTimer = setTimeout(() => {
            showNotification(
              "warning",
              "Session expir√©e",
              "Vous avez √©t√© d√©connect√© apr√®s 10 minutes d'inactivit√©"
            );
            logout();
          }, INACTIVITY_TIMEOUT);
        }
      }

      function trackActivity() {
        resetInactivityTimer();
      }

      // √âcouter les √©v√©nements d'activit√©
      document.addEventListener("click", trackActivity);
      document.addEventListener("keypress", trackActivity);
      document.addEventListener("scroll", trackActivity);
      document.addEventListener("mousemove", trackActivity);

      // Fonctions "Se souvenir de moi"
      function saveCredentials(email, password) {
        if (
          confirm(
            "Voulez-vous vraiment enregistrer vos identifiants ? (Les donn√©es seront chiffr√©es localement)"
          )
        ) {
          const credentials = {
            username: email, // On stocke l'email comme "username"
            // Simple encodage Base64 pour l'exemple (en production, utiliser un vrai chiffrement)
            password: btoa(password),
            savedAt: Date.now(),
          };
          localStorage.setItem("savedCredentials", JSON.stringify(credentials));
          console.log("‚úÖ Identifiants sauvegard√©s localement");
        }
      }

      function loadSavedCredentials() {
        const saved = localStorage.getItem("savedCredentials");
        if (saved) {
          try {
            const credentials = JSON.parse(saved);
            return {
              username: credentials.username,
              password: atob(credentials.password), // D√©coder Base64
              savedAt: credentials.savedAt,
            };
          } catch (e) {
            console.error("Erreur lecture identifiants:", e);
            localStorage.removeItem("savedCredentials");
          }
        }
        return null;
      }

      function clearSavedCredentials() {
        localStorage.removeItem("savedCredentials");
      }

      // Pr√©-remplir les formulaires si identifiants sauvegard√©s
      function fillLoginForm() {
        const saved = loadSavedCredentials();
        if (saved) {
          document.getElementById("login-email").value = saved.username;
          document.getElementById("login-password").value = saved.password;
          document.getElementById("remember-me-login").checked = true;

          // Afficher un message visuel que les identifiants sont charg√©s
          console.log("‚úÖ Identifiants pr√©-remplis depuis le stockage local");
        }
      }

      // V√©rifier s'il y a un token de r√©initialisation dans l'URL
      function checkResetPasswordToken() {
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");

        if (token) {
          // Attendre que le DOM soit compl√®tement charg√©
          setTimeout(() => {
            const tokenInput = document.getElementById("reset-token");
            if (tokenInput) {
              tokenInput.value = token;
              showSection("reset-password-section");
              showNotification(
                "info",
                "Token d√©tect√©",
                "Vous pouvez maintenant d√©finir votre nouveau mot de passe."
              );
            } else {
              console.error("Champ reset-token non trouv√© dans le DOM");
            }
          }, 100);
        }
      }

      // Gestion du menu mobile
      function toggleMobileMenu() {
        const mobileMenu = document.getElementById("mobile-menu");
        mobileMenu.classList.toggle("hidden");
      }

      // Gestion des sections
      function showSection(sectionId) {
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.add("hidden");
          section.classList.remove("active");
        });

        const section = document.getElementById(sectionId);
        if (section) {
          section.classList.remove("hidden");
          section.classList.add("active");
        }

        if (sectionId === "events") {
          loadEvents();
        }

        // Pr√©-remplir le formulaire de connexion si on va sur cette section
        if (sectionId === "login") {
          setTimeout(() => fillLoginForm(), 100); // Petit d√©lai pour s'assurer que les √©l√©ments sont visibles
        }

        updateNavigation();
      }

      // Mettre √† jour la navigation selon l'√©tat de connexion
      function updateNavigation() {
        const loginBtn = document.getElementById("login-btn");
        const registerBtn = document.getElementById("register-btn");
        const logoutBtn = document.getElementById("logout-btn");
        const myRatingsBtn = document.getElementById("my-ratings-btn");
        const myEventsBtn = document.getElementById("my-events-btn");

        // Boutons mobiles
        const mobileLoginBtn = document.getElementById("mobile-login-btn");
        const mobileRegisterBtn = document.getElementById(
          "mobile-register-btn"
        );
        const mobileLogoutBtn = document.getElementById("mobile-logout-btn");
        const mobileMyRatingsBtn = document.getElementById(
          "mobile-my-ratings-btn"
        );
        const mobileMyEventsBtn = document.getElementById(
          "mobile-my-events-btn"
        );
        const createEventBtn = document.getElementById("create-event-btn");

        if (currentUser && authToken) {
          // Utilisateur connect√© : masquer connexion/inscription, afficher d√©connexion et mes avis/√©v√©nements
          loginBtn.style.display = "none";
          registerBtn.style.display = "none";
          logoutBtn.style.display = "block";
          myRatingsBtn.style.display = "block";
          myEventsBtn.style.display = "block";
          createEventBtn.textContent = "Cr√©er un √©v√©nement";
          createEventBtn.className =
            "bg-primary-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-primary-700";

          // Boutons mobiles
          mobileLoginBtn.style.display = "none";
          mobileRegisterBtn.style.display = "none";
          mobileLogoutBtn.style.display = "block";
          mobileMyRatingsBtn.style.display = "block";
          mobileMyEventsBtn.style.display = "block";
        } else {
          // Visiteur : afficher connexion/inscription, masquer d√©connexion et mes avis/√©v√©nements
          loginBtn.style.display = "block";
          registerBtn.style.display = "block";
          logoutBtn.style.display = "none";
          myRatingsBtn.style.display = "none";
          myEventsBtn.style.display = "none";
          createEventBtn.textContent = "Se connecter pour cr√©er";
          createEventBtn.className =
            "bg-gray-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-gray-600 cursor-not-allowed";

          // Boutons mobiles
          mobileLoginBtn.style.display = "block";
          mobileRegisterBtn.style.display = "block";
          mobileLogoutBtn.style.display = "none";
          mobileMyRatingsBtn.style.display = "none";
          mobileMyEventsBtn.style.display = "none";
        }
      }

      // G√©rer le clic sur "Cr√©er un √©v√©nement"
      function handleCreateEvent() {
        if (currentUser && authToken) {
          // Utilisateur connect√© : aller √† la cr√©ation d'√©v√©nement
          showSection("create-event");
        } else {
          // Visiteur : rediriger vers la connexion
          showNotification(
            "info",
            "Connexion requise",
            "Vous devez vous connecter pour cr√©er un √©v√©nement."
          );
          showSection("login");
        }
      }

      // Notification
      function showNotification(type, title, message) {
        const notification = document.getElementById("notification");
        const icon = document.getElementById("notification-icon");
        const titleEl = document.getElementById("notification-title");
        const messageEl = document.getElementById("notification-message");

        let iconHtml = "";
        let bgColor = "";

        switch (type) {
          case "success":
            iconHtml =
              '<svg class="h-6 w-6 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
            bgColor = "border-green-200 bg-green-50";
            break;
          case "error":
            iconHtml =
              '<svg class="h-6 w-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';
            bgColor = "border-red-200 bg-red-50";
            break;
          case "info":
            iconHtml =
              '<svg class="h-6 w-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            bgColor = "border-blue-200 bg-blue-50";
            break;
        }

        icon.innerHTML = iconHtml;
        titleEl.textContent = title;
        messageEl.textContent = message;

        notification.className = `fixed top-4 right-4 z-50 ${bgColor} border rounded-lg shadow-lg p-4 max-w-sm`;
        notification.classList.remove("hidden");

        setTimeout(() => {
          notification.classList.add("hidden");
        }, 2000);
      }

      // Variables globales pour les filtres
      let allEvents = [];
      let filteredEvents = [];
      let currentViewMode = "grid"; // 'grid' ou 'list'

      // Charger les √©v√©nements depuis l'API
      async function loadEvents() {
        try {
          const response = await fetch(EVENTS_ENDPOINT);
          const data = await response.json();

          // S'assurer que data est un tableau
          allEvents = Array.isArray(data) ? data : [];

          // Pr√©charger les images en arri√®re-plan (sans d√©lai)
          preloadImages(allEvents);

          // Les √©v√©nements sont d√©j√† dans le bon format depuis l'API
          filteredEvents = [...allEvents];
          populateFilterOptions();
          applyFilters();
          
          // Configurer le lazy loading apr√®s affichage
          setTimeout(() => setupLazyLoading(), 100);
        } catch (error) {
          console.error("Erreur lors du chargement des √©v√©nements:", error);
          document.getElementById("events-container").innerHTML = `
                    <div class="col-span-full text-center text-gray-500">
                        Erreur lors du chargement des √©v√©nements. Assurez-vous que l'API est d√©marr√©e sur http://localhost:5001
                    </div>
                `;
        }
      }

      // Afficher les √©v√©nements filtr√©s
      function displayEvents() {
        const container = document.getElementById("events-container");
        const noEventsMessage = document.getElementById("no-events-found");

        container.innerHTML = "";

        if (filteredEvents.length === 0) {
          container.style.display = "none";
          noEventsMessage.classList.remove("hidden");
          return;
        }

        container.style.display = currentViewMode === "grid" ? "grid" : "block";
        noEventsMessage.classList.add("hidden");

        filteredEvents.forEach((event) => {
          const eventCard = createEventCard(event);
          container.appendChild(eventCard);
        });
      }

      // Cr√©er une carte d'√©v√©nement
      function createEventCard(event) {
        const card = document.createElement("div");
        card.className = "event-card";

        // Afficher les photos si disponibles
        const photos = event.photos || event.images || [];
        const photosHtml =
          photos && photos.length > 0
            ? `
          <div class="w-full h-48 bg-gray-200 rounded-lg mb-4 overflow-hidden">
            <div class="flex space-x-2 h-full">
              ${photos
                .map(
                  (photo) => `
                <img src="${photo}" alt="Photo de l'√©v√©nement" class="w-full h-full object-contain bg-gray-100 flex-shrink-0" loading="lazy" decoding="async">
              `
                )
                .join("")}
            </div>
          </div>
        `
            : `
          <div class="w-full h-48 bg-gray-200 rounded-lg mb-4 flex items-center justify-center">
            <svg class="h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
        `;

        card.innerHTML = `
          ${photosHtml}
          
          <!-- En-t√™te avec titre et cat√©gorie -->
          <div class="mb-3">
            <div class="flex items-start justify-between mb-2 gap-2">
              <h3 class="text-lg sm:text-xl font-semibold text-gray-900 flex-1 break-words min-w-0">${
                event.title
              }</h3>
              <div class="flex flex-col sm:flex-row gap-1 sm:gap-2">
                <span class="category-badge category-${(
                  event.category || "general"
                ).toLowerCase()}">
                  üè∑Ô∏è ${event.category || "G√©n√©ral"}
              </span>
                ${(() => {
                  const status = getEventStatus(event);
                  return `<span class="status-badge ${
                    status.status === "upcoming"
                      ? "status-upcoming"
                      : status.status === "ongoing"
                      ? "status-ongoing"
                      : "status-ended"
                  }">
                    ${status.icon} ${status.text}
                  </span>`;
                })()}
            </div>
            </div>
            <p class="text-gray-600 text-sm leading-relaxed break-words overflow-hidden">${
              event.description
            }</p>
          </div>

          <!-- Informations d√©taill√©es -->
          <div class="space-y-3 mb-4">
            <!-- Dates -->
            <div class="flex items-start">
              <svg class="h-4 w-4 mr-2 mt-0.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <div class="text-sm flex-1 min-w-0">
                <div class="font-medium text-gray-900 break-words">üìÖ ${formatEventDateRange(
                  event
                )}</div>
                ${
                  event.date_start === event.date_end
                    ? ""
                    : `<div class="text-gray-500 text-xs break-words">Jusqu'au ${formatEventDate(
                        event.date_end
                      )}</div>`
                }
              </div>
            </div>

            <!-- Lieu complet -->
            <div class="flex items-start">
              <svg class="h-4 w-4 mr-2 mt-0.5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
              </svg>
              <div class="text-sm flex-1 min-w-0">
                <div class="font-medium text-gray-900 break-words">üìç ${
                  event.location_address || "Adresse non pr√©cis√©e"
                }</div>
                <div class="text-gray-500 break-words">${
                  event.location_city || "Ville non pr√©cis√©e"
                }</div>
              </div>
            </div>

          </div>

          <!-- Prix et note -->
          <div class="flex items-center justify-between mb-4 pt-3 border-t border-gray-100">
            <div class="flex items-center">
              <span class="text-lg font-bold text-primary-600">
                ${
                  event.price_is_free
                    ? "üÜì Gratuit"
                    : "üí∞ " + event.price_amount + "‚Ç¨"
                }
              </span>
            </div>
            ${
              event.rating_average && event.rating_average > 0
                ? `
                <div class="flex items-center">
                  <svg class="h-4 w-4 mr-1 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.783.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                  </svg>
                  <span class="text-sm font-medium text-gray-900">${parseFloat(
                    event.rating_average
                  ).toFixed(1)}</span>
                  <span class="ml-1 text-xs text-gray-500">(${
                    event.rating_count || 0
                  } avis)</span>
                </div>
                `
                : ""
            }
          </div>

          <!-- Boutons d'action -->
          <div class="flex flex-col sm:flex-row gap-3">
            <button onclick="rateEvent(${
              event.id
            })" class="btn-gradient flex-1">
              ‚≠ê Noter
            </button>
            <button onclick="showEventRatings(${
              event.id
            }, this)" class="glass-card text-gray-700 py-2 px-4 rounded-lg text-sm font-medium hover:bg-gray-100 transition-all duration-300 flex-1 flex items-center justify-center space-x-2">
              <span>üí¨</span>
              <span>Voir avis</span>
            </button>
          </div>
        `;

        return card;
      }

      // Remplir automatiquement les options de filtre
      function populateFilterOptions() {
        // Remplir les villes
        const cities = [
          ...new Set(
            allEvents.map((event) => event.location_city).filter((city) => city)
          ),
        ];
        cities.sort();

        const cityFilter = document.getElementById("city-filter");
        // Garder l'option "Toutes les villes"
        cityFilter.innerHTML = '<option value="">Toutes les villes</option>';
        cities.forEach((city) => {
          cityFilter.innerHTML += `<option value="${city}">${city}</option>`;
        });
      }

      // Fonctions utilitaires pour les filtres de date
      function isToday(date) {
        const today = new Date();
        const eventDate = new Date(date);
        return eventDate.toDateString() === today.toDateString();
      }

      function isTomorrow(date) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        const eventDate = new Date(date);
        return eventDate.toDateString() === tomorrow.toDateString();
      }

      function isThisWeek(date) {
        const today = new Date();
        const eventDate = new Date(date);
        const startOfWeek = new Date(
          today.setDate(today.getDate() - today.getDay())
        );
        const endOfWeek = new Date(
          today.setDate(today.getDate() - today.getDay() + 6)
        );
        return eventDate >= startOfWeek && eventDate <= endOfWeek;
      }

      function isNextWeek(date) {
        const today = new Date();
        const eventDate = new Date(date);
        const startOfNextWeek = new Date(
          today.setDate(today.getDate() - today.getDay() + 7)
        );
        const endOfNextWeek = new Date(
          today.setDate(today.getDate() - today.getDay() + 13)
        );
        return eventDate >= startOfNextWeek && eventDate <= endOfNextWeek;
      }

      function isThisMonth(date) {
        const today = new Date();
        const eventDate = new Date(date);
        return (
          eventDate.getMonth() === today.getMonth() &&
          eventDate.getFullYear() === today.getFullYear()
        );
      }

      function isNextMonth(date) {
        const today = new Date();
        const eventDate = new Date(date);
        const nextMonth = new Date(today.getFullYear(), today.getMonth() + 1);
        return (
          eventDate.getMonth() === nextMonth.getMonth() &&
          eventDate.getFullYear() === nextMonth.getFullYear()
        );
      }

      // Filtrage et tri avanc√©s (optimis√© avec debouncing)
      const applyFilters = debounce(function () {
        const searchText = document
          .getElementById("search-events")
          .value.toLowerCase();
        const category = document.getElementById("category-filter").value;
        const city = document.getElementById("city-filter").value;
        const priceRange = document.getElementById("price-filter").value;
        const minRating = parseFloat(
          document.getElementById("rating-filter").value
        );
        const dateFilter = document.getElementById("date-filter").value;
        const sortBy = document.getElementById("sort-select").value;

        // Afficher/masquer le bouton clear search
        const clearBtn = document.getElementById("clear-search-btn");
        clearBtn.style.display = searchText ? "flex" : "none";

        // Filtrer les √©v√©nements
        filteredEvents = allEvents.filter((event) => {
          // Filtre de recherche textuelle
          const matchesSearch =
            !searchText ||
            event.title.toLowerCase().includes(searchText) ||
            event.description.toLowerCase().includes(searchText) ||
            event.location_city.toLowerCase().includes(searchText) ||
            event.location_address.toLowerCase().includes(searchText) ||
            event.creator_username.toLowerCase().includes(searchText);

          // Filtre par cat√©gorie
          const matchesCategory = !category || event.category === category;

          // Filtre par ville
          const matchesCity = !city || event.location_city === city;

          // Filtre par prix
          let matchesPrice = true;
          if (priceRange) {
            const price = event.price_is_free
              ? 0
              : parseFloat(event.price_amount) || 0;
            switch (priceRange) {
              case "free":
                matchesPrice = event.price_is_free || price === 0;
                break;
              case "0-10":
                matchesPrice = price >= 0 && price <= 10;
                break;
              case "10-25":
                matchesPrice = price > 10 && price <= 25;
                break;
              case "25-50":
                matchesPrice = price > 25 && price <= 50;
                break;
              case "50+":
                matchesPrice = price > 50;
                break;
            }
          }

          // Filtre par note minimum
          const matchesRating =
            !minRating ||
            (event.rating_average &&
              parseFloat(event.rating_average) >= minRating);

          // Filtre par date
          let matchesDate = true;
          if (dateFilter && event.date_start) {
            switch (dateFilter) {
              case "today":
                matchesDate = isToday(event.date_start);
                break;
              case "tomorrow":
                matchesDate = isTomorrow(event.date_start);
                break;
              case "this-week":
                matchesDate = isThisWeek(event.date_start);
                break;
              case "next-week":
                matchesDate = isNextWeek(event.date_start);
                break;
              case "this-month":
                matchesDate = isThisMonth(event.date_start);
                break;
              case "next-month":
                matchesDate = isNextMonth(event.date_start);
                break;
            }
          }

          return (
            matchesSearch &&
            matchesCategory &&
            matchesCity &&
            matchesPrice &&
            matchesRating &&
            matchesDate
          );
        });

        // Trier les √©v√©nements
        filteredEvents.sort((a, b) => {
          switch (sortBy) {
            case "date-asc":
              // Tri par date : √©v√©nements en cours d'abord, puis par date de d√©but
              const now = new Date();
              const aStart = new Date(a.date_start);
              const bStart = new Date(b.date_start);
              const aEnd = new Date(a.date_end || a.date_start);
              const bEnd = new Date(b.date_end || b.date_start);

              // √âv√©nements en cours d'abord
              const aOngoing = aStart <= now && aEnd >= now;
              const bOngoing = bStart <= now && bEnd >= now;

              // √âv√©nements termin√©s
              const aEnded = aEnd < now;
              const bEnded = bEnd < now;

              if (aOngoing && !bOngoing) return -1;
              if (!aOngoing && bOngoing) return 1;

              // √âv√©nements termin√©s en dernier
              if (aEnded && !bEnded) return 1;
              if (!aEnded && bEnded) return -1;

              // Puis par date de d√©but (plus proche en premier)
              return aStart - bStart;

            case "date-desc":
              // Tri par date : √©v√©nements en cours d'abord, puis par date de d√©but (plus lointaine en premier)
              const nowDesc = new Date();
              const aStartDesc = new Date(a.date_start);
              const bStartDesc = new Date(b.date_start);
              const aEndDesc = new Date(a.date_end || a.date_start);
              const bEndDesc = new Date(b.date_end || b.date_start);

              // √âv√©nements en cours d'abord
              const aOngoingDesc = aStartDesc <= nowDesc && aEndDesc >= nowDesc;
              const bOngoingDesc = bStartDesc <= nowDesc && bEndDesc >= nowDesc;

              // √âv√©nements termin√©s
              const aEndedDesc = aEndDesc < nowDesc;
              const bEndedDesc = bEndDesc < nowDesc;

              if (aOngoingDesc && !bOngoingDesc) return -1;
              if (!aOngoingDesc && bOngoingDesc) return 1;

              // √âv√©nements termin√©s en dernier
              if (aEndedDesc && !bEndedDesc) return 1;
              if (!aEndedDesc && bEndedDesc) return -1;

              // Puis par date de d√©but (plus lointaine en premier)
              return bStartDesc - aStartDesc;
            case "price-asc":
              const priceA = a.price_is_free
                ? 0
                : parseFloat(a.price_amount) || 0;
              const priceB = b.price_is_free
                ? 0
                : parseFloat(b.price_amount) || 0;
              return priceA - priceB;
            case "price-desc":
              const priceA2 = a.price_is_free
                ? 0
                : parseFloat(a.price_amount) || 0;
              const priceB2 = b.price_is_free
                ? 0
                : parseFloat(b.price_amount) || 0;
              return priceB2 - priceA2;
            case "title-asc":
              return a.title.localeCompare(b.title);
            case "title-desc":
              return b.title.localeCompare(a.title);
            case "rating-desc":
              return (
                (parseFloat(b.rating_average) || 0) -
                (parseFloat(a.rating_average) || 0)
              );
            case "popularity-desc":
              return (b.rating_average || 0) - (a.rating_average || 0);
            case "recent-desc":
              return new Date(b.created_at) - new Date(a.created_at);
            default:
              // Tri par d√©faut : √©v√©nements en cours d'abord, puis par date
              const nowDefault = new Date();
              const aStartDefault = new Date(a.date_start);
              const bStartDefault = new Date(b.date_start);
              const aEndDefault = new Date(a.date_end || a.date_start);
              const bEndDefault = new Date(b.date_end || b.date_start);

              const aOngoingDefault =
                aStartDefault <= nowDefault && aEndDefault >= nowDefault;
              const bOngoingDefault =
                bStartDefault <= nowDefault && bEndDefault >= nowDefault;

              if (aOngoingDefault && !bOngoingDefault) return -1;
              if (!aOngoingDefault && bOngoingDefault) return 1;

              return aStartDefault - bStartDefault;
          }
        });

        displayEvents();
        updateEventsCount();
      }, 100); // Debounce de 100ms

      // Fonctions utilitaires pour le formatage
      function isValidUrl(string) {
        try {
          new URL(string);
          return true;
        } catch (_) {
          return false;
        }
      }

      function formatEventDateRange(event) {
        if (!event.date_start) return "Date non d√©finie";

        const startDate = new Date(event.date_start);
        const endDate = event.date_end ? new Date(event.date_end) : null;

        const formatDate = (date) => {
          return date.toLocaleDateString("fr-FR", {
            weekday: "long",
            day: "numeric",
            month: "long",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        };

        if (!endDate || startDate.toDateString() === endDate.toDateString()) {
          return formatDate(startDate);
        } else {
          return `Du ${formatDate(startDate)} au ${formatDate(endDate)}`;
        }
      }

      function formatRating(event) {
        if (
          !event.rating_average ||
          event.rating_average === 0 ||
          isNaN(event.rating_average) ||
          !isFinite(event.rating_average)
        ) {
          return "Pas encore d'avis";
        }
        const rating = parseFloat(event.rating_average);
        const count = event.rating_count || 0;
        return `${rating.toFixed(1)}/5 (${count} avis)`;
      }

      // Nouvelles fonctions utilitaires
      function clearSearch() {
        document.getElementById("search-events").value = "";
        applyFilters();
      }

      function updateEventsCount() {
        const count = filteredEvents.length;
        const countElement = document.getElementById("events-count");
        if (countElement) {
          countElement.textContent = `${count} √©v√©nement(s)`;
        }
      }

      function setViewMode(mode) {
        currentViewMode = mode;

        // Mettre √† jour les boutons
        document
          .querySelectorAll(".view-toggle")
          .forEach((btn) => btn.classList.remove("active"));
        if (mode === "grid") {
          document.getElementById("grid-view-btn").classList.add("active");
          document.getElementById("events-container").className =
            "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8";
        } else {
          document.getElementById("list-view-btn").classList.add("active");
          document.getElementById("events-container").className = "space-y-6";
        }

        displayEvents();
      }

      // R√©initialiser tous les filtres
      function resetFilters() {
        document.getElementById("search-events").value = "";
        document.getElementById("sort-select").value = "date-asc";
        document.getElementById("category-filter").value = "";
        document.getElementById("city-filter").value = "";
        document.getElementById("price-filter").value = "";
        document.getElementById("rating-filter").value = "0";
        document.getElementById("date-filter").value = "";

        // Masquer le bouton clear search
        document.getElementById("clear-search-btn").style.display = "none";

        filteredEvents = [...allEvents];
        displayEvents();
        updateEventsCount();
      }

      // Variables globales pour les photos et doublons
      let selectedPhotoUrls = [];
      let pendingEventData = null;
      let similarEvents = [];

      // Pr√©visualisation des images depuis URL
      function previewImageUrl(input, index) {
        const url = input.value.trim();
        const preview = document.getElementById("photo-preview");

        // Mettre √† jour le tableau des URLs
        selectedPhotoUrls[index - 1] = url;

        // Nettoyer le tableau des URLs vides
        selectedPhotoUrls = selectedPhotoUrls.filter(
          (url) => url && url.length > 0
        );

        // R√©afficher la pr√©visualisation
        updatePhotoPreview();
      }

      // Mettre √† jour l'affichage des pr√©visualisations
      function updatePhotoPreview() {
        const preview = document.getElementById("photo-preview");
        preview.innerHTML = "";

        if (selectedPhotoUrls.length > 0) {
          preview.classList.remove("hidden");

          selectedPhotoUrls.forEach((url, index) => {
            const previewItem = document.createElement("div");
            previewItem.className = "relative";
            previewItem.innerHTML = `
              <img src="${url}" class="w-full h-32 object-contain bg-gray-100 rounded-lg" alt="Pr√©visualisation" loading="lazy" decoding="async"
                   onerror="this.src='https://via.placeholder.com/400x300/E5E7EB/6B7280?text=Image+non+trouv√©e'" />
              <button onclick="removePhotoUrl(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-600">
                   √ó
                 </button>
               `;
            preview.appendChild(previewItem);
          });
        } else {
          preview.classList.add("hidden");
        }
      }

      // Supprimer une URL de photo
      function removePhotoUrl(index) {
        selectedPhotoUrls.splice(index, 1);

        // R√©initialiser les champs de saisie
        for (let i = 1; i <= 3; i++) {
          const input = document.getElementById(`event-photo-url-${i}`);
          input.value = selectedPhotoUrls[i - 1] || "";
        }

        updatePhotoPreview();
      }

      // Afficher le modal de comparaison des doublons
      function showDuplicateModal(newEventData, similarEventsData) {
        pendingEventData = newEventData;
        similarEvents = similarEventsData;

        // Afficher les d√©tails du nouvel √©v√©nement
        const newEventDetails = document.getElementById("new-event-details");
        newEventDetails.innerHTML = `
           <div class="grid grid-cols-2 gap-4">
             <div>
               <strong>Titre:</strong> ${newEventData.title}<br>
               <strong>Cat√©gorie:</strong> ${newEventData.category}<br>
               <strong>Ville:</strong> ${newEventData.locationCity}<br>
               <strong>Date:</strong> ${new Date(
                 newEventData.dateStart
               ).toLocaleDateString()}
             </div>
             <div>
               <strong>Description:</strong> ${newEventData.description}<br>
               <strong>Prix:</strong> ${
                 newEventData.priceIsFree
                   ? "Gratuit"
                   : newEventData.priceAmount + "‚Ç¨"
               }
             </div>
           </div>
         `;

        // Afficher les √©v√©nements similaires
        const similarEventsList = document.getElementById(
          "similar-events-list"
        );
        similarEventsList.innerHTML = "";

        similarEventsData.forEach((event) => {
          const eventCard = document.createElement("div");
          eventCard.className =
            "bg-white border border-gray-200 rounded-lg p-4";
          eventCard.innerHTML = `
             <div class="grid grid-cols-2 gap-4">
               <div>
                 <strong>Titre:</strong> ${event.title}<br>
                 <strong>Cat√©gorie:</strong> ${event.category}<br>
                 <strong>Ville:</strong> ${event.location_city}<br>
                 <strong>Date:</strong> ${new Date(
                   event.date_start
                 ).toLocaleDateString()}
               </div>
               <div>
                 <strong>Description:</strong> ${event.description}<br>
                 <strong>Prix:</strong> ${
                   event.price_is_free ? "Gratuit" : event.price_amount + "‚Ç¨"
                 }<br>
                 <strong>Cr√©√© par:</strong> ${event.creator_username}
               </div>
             </div>
           `;
          similarEventsList.appendChild(eventCard);
        });

        document.getElementById("duplicate-modal").classList.remove("hidden");
      }

      // Fermer le modal de comparaison
      function closeDuplicateModal() {
        document.getElementById("duplicate-modal").classList.add("hidden");
        pendingEventData = null;
        similarEvents = [];
      }

      // Confirmer la cr√©ation d'√©v√©nement malgr√© les doublons
      async function confirmCreateEvent() {
        if (pendingEventData) {
          await createEventWithPhotos(pendingEventData);
          closeDuplicateModal();
        }
      }

      // Afficher les avis d'un √©v√©nement
      async function showEventRatings(eventId, clickedElement = null) {
        try {
          const response = await fetch(`${API_BASE}/ratings`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ action: "get", eventId: eventId }),
          });
          const data = await response.json();

          if (response.ok) {
            displayEventRatings(data);
            document.getElementById("ratings-modal").classList.remove("hidden");

            // Ajouter toutes les m√©thodes de fermeture standard
            setupRatingsModalCloseMethods();

            // Fermeture automatique configur√©e dans le HTML

            // Positionner la fen√™tre directement sur la zone de la carte sur mobile
            if (window.innerWidth <= 768) {
              setTimeout(() => {
                const modal = document.getElementById("ratings-modal");
                const clickedButton = clickedElement;
                const eventCard = clickedButton.closest(
                  ".event-card, .event-card-simple"
                );

                if (modal && eventCard) {
                  // Calculer la position de la carte
                  const cardRect = eventCard.getBoundingClientRect();
                  const scrollTop =
                    window.pageYOffset || document.documentElement.scrollTop;

                  // Positionner la fen√™tre directement sur la carte
                  modal.style.position = "absolute";
                  modal.style.top = cardRect.top + scrollTop + "px";
                  modal.style.left = "10px";
                  modal.style.right = "10px";
                  modal.style.width = "auto";
                  modal.style.maxHeight = "80vh";
                  modal.style.overflowY = "auto";
                  modal.style.zIndex = "9999";
                  modal.style.backgroundColor = "rgba(255, 255, 255, 0.98)";
                  modal.style.backdropFilter = "blur(10px)";

                  // Scroll pour centrer la fen√™tre
                  const modalCenter =
                    cardRect.top + scrollTop + cardRect.height / 2;
                  const viewportCenter = window.innerHeight / 2;
                  const scrollTo = modalCenter - viewportCenter;

                  window.scrollTo({
                    top: Math.max(0, scrollTo),
                    behavior: "smooth",
                  });
                }
              }, 100);
            }
          } else {
            showNotification(
              "error",
              "Erreur",
              "Impossible de charger les avis"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Afficher les avis dans le modal (nouveau syst√®me intelligent)
      function displayEventRatings(ratings) {
        const content = document.getElementById("ratings-content");

        if (ratings.length === 0) {
          content.innerHTML = `
             <div class="text-center py-8">
               <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                 <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
               </svg>
               <h3 class="mt-2 text-sm font-medium text-gray-900">Aucun avis</h3>
               <p class="mt-1 text-sm text-gray-500">Soyez le premier √† noter cet √©v√©nement !</p>
             </div>
           `;
          return;
        }

        content.innerHTML = `
           <div class="space-y-4">
             ${ratings
               .map(
                 (rating) => `
               <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm">
                 <!-- En-t√™te avec note et timing -->
                 <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between mb-4 gap-3">
                   <div class="flex-1 min-w-0">
                     <div class="flex items-center space-x-2 sm:space-x-3 mb-2">
                       <div class="flex items-center space-x-2 flex-shrink-0">
                         <div class="flex text-gray-300 text-sm">
                           ${Array.from({ length: 10 }, (_, i) => {
                             const starRating = rating.overall_rating;
                             const filledBars = Math.round(starRating * 2); // 3.5 ‚Üí 7 barres
                             return i < filledBars ? "‚ñà" : "‚ñë";
                           }).join("")}
                   </div>
                         <span class="text-sm font-bold text-gray-700">${
                           rating.overall_rating
                       }/5</span>
                   </div>
                   </div>
                     ${formatRatingDate(rating.created_at, rating)}
                   </div>
                 </div>
                 
                 <!-- Tags rapides -->
                 ${formatQuickTags(rating.quick_tags)}

                 <!-- Crit√®res d√©taill√©s -->
                 ${formatDetailedCriteria(rating.detailed_criteria)}

                 <!-- Commentaire -->
                 ${
                   rating.comment
                     ? `
                   <div class="bg-white p-3 sm:p-4 rounded-lg border-l-4 border-blue-500 mb-4">
                     <div class="flex items-start space-x-2">
                       <svg class="w-4 h-4 sm:w-5 sm:h-5 text-blue-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                       </svg>
                       <p class="text-gray-700 italic text-sm sm:text-base break-words">"${rating.comment}"</p>
                   </div>
                   </div>
                 `
                     : ""
                 }
                 
                 <!-- Informations contextuelles -->
                 ${formatContextInfo(rating)}
                   </div>
                   `
               )
               .join("")}
                   </div>
         `;
      }

      // Fonction pour pr√©charger les images
      function preloadImages(events) {
        events.forEach((event) => {
          const photos = event.photos || event.images || [];
          photos.forEach((photoUrl) => {
            const img = new Image();
            img.src = photoUrl;
            img.loading = "eager"; // Chargement prioritaire
          });
        });
      }


      // Fonction de debouncing pour optimiser les performances
      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      // Fonction pour d√©terminer le statut d'un √©v√©nement
      function getEventStatus(event) {
        const now = new Date();
        const startDate = new Date(event.date_start);
        const endDate = event.date_end ? new Date(event.date_end) : startDate;

        // Calculer les diff√©rences en millisecondes pour plus de pr√©cision
        const diffStartMs = startDate.getTime() - now.getTime();
        const diffEndMs = endDate.getTime() - now.getTime();

        // Si l'√©v√©nement n'a pas encore commenc√©
        if (diffStartMs > 0) {
          // V√©rifier si c'est le m√™me jour
          const today = new Date();
          const eventDate = new Date(event.date_start);
          const isSameDay = today.toDateString() === eventDate.toDateString();

          const diffHours = Math.ceil(diffStartMs / (1000 * 60 * 60));
          const diffMinutes = Math.ceil(diffStartMs / (1000 * 60));

          // Si c'est aujourd'hui mais dans le futur
          if (isSameDay) {
            return {
              status: "upcoming",
              text: "Aujourd'hui",
              color: "bg-orange-100 text-orange-800",
              icon: "üåÖ",
            };
          }
          // Si c'est demain
          else {
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            const isTomorrow =
              tomorrow.toDateString() === eventDate.toDateString();

            if (isTomorrow) {
              return {
                status: "upcoming",
                text: "Demain",
                color: "bg-blue-100 text-blue-800",
                icon: "üìÖ",
              };
            } else {
              const diffDays = Math.ceil(diffStartMs / (1000 * 60 * 60 * 24));
              if (diffDays <= 7) {
                return {
                  status: "upcoming",
                  text: `Dans ${diffDays} jours`,
                  color: "bg-blue-100 text-blue-800",
                  icon: "üìÖ",
                };
              } else {
                return {
                  status: "upcoming",
                  text: "√Ä venir",
                  color: "bg-blue-100 text-blue-800",
                  icon: "üìÖ",
                };
              }
            }
          }
        }

        // Si l'√©v√©nement est en cours (commenc√© et pas encore fini)
        if (diffStartMs <= 0 && diffEndMs >= 0) {
          return {
            status: "ongoing",
            text: "En cours",
            color: "bg-green-100 text-green-800",
            icon: "üü¢",
          };
        }

        // Si l'√©v√©nement est termin√©
        if (diffEndMs < 0) {
          return {
            status: "ended",
            text: "Termin√©",
            color: "bg-gray-100 text-gray-800",
            icon: "üî¥",
          };
        }

        // Par d√©faut, √©v√©nement en cours
        return {
          status: "ongoing",
          text: "En cours",
          color: "bg-green-100 text-green-800",
          icon: "üü¢",
        };
      }

      // Fonctions utilitaires pour l'affichage des avis intelligents

      function formatRating(rating) {
        if (!rating || rating === 0) return "0/5";

        // Convertir en nombre si c'est une cha√Æne
        const numRating =
          typeof rating === "string" ? parseFloat(rating) : rating;

        // V√©rifier que c'est bien un nombre valide
        if (isNaN(numRating) || !isFinite(numRating)) {
          return "0/5";
        }

        // Si c'est un nombre entier, afficher sans d√©cimales
        if (numRating % 1 === 0) {
          return `${numRating}/5`;
        }

        // Sinon, afficher avec une d√©cimale maximum
        return `${numRating.toFixed(1)}/5`;
      }

      function formatRatingDate(dateString, rating = null) {
        const date = new Date(dateString);
        const now = new Date();

        // Normaliser les dates pour comparer seulement les jours (sans heures)
        const dateOnly = new Date(
          date.getFullYear(),
          date.getMonth(),
          date.getDate()
        );
        const nowOnly = new Date(
          now.getFullYear(),
          now.getMonth(),
          now.getDate()
        );

        const diffTime = nowOnly - dateOnly;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

        // Date pr√©cise
        const preciseDate = date.toLocaleDateString("fr-FR", {
          weekday: "long",
          day: "numeric",
          month: "long",
          year: "numeric",
        });

        // Temps relatif - plus pr√©cis
        let relativeTime = "";
        if (diffDays === 0) {
          relativeTime = "Aujourd'hui";
        } else if (diffDays === 1) {
          relativeTime = "Hier";
        } else if (diffDays === -1) {
          relativeTime = "Demain";
        } else if (diffDays > 1 && diffDays < 7) {
          relativeTime = `Il y a ${diffDays} jours`;
        } else if (diffDays >= 7 && diffDays < 30) {
          const weeks = Math.floor(diffDays / 7);
          const remainingDays = diffDays % 7;
          if (remainingDays === 0) {
            relativeTime = `Il y a ${weeks} semaine${weeks > 1 ? "s" : ""}`;
          } else {
            relativeTime = `Il y a ${weeks} semaine${
              weeks > 1 ? "s" : ""
            } et ${remainingDays} jour${remainingDays > 1 ? "s" : ""}`;
          }
        } else if (diffDays >= 30 && diffDays < 365) {
          const months = Math.floor(diffDays / 30);
          const remainingDays = diffDays % 30;
          if (remainingDays === 0) {
            relativeTime = `Il y a ${months} mois`;
          } else {
            relativeTime = `Il y a ${months} mois et ${remainingDays} jour${
              remainingDays > 1 ? "s" : ""
            }`;
          }
        } else if (diffDays >= 365) {
          const years = Math.floor(diffDays / 365);
          relativeTime = `Il y a ${years} an${years > 1 ? "s" : ""}`;
        } else {
          relativeTime = "Date inconnue";
        }

        // Ajouter l'horaire si disponible
        let timingText = "";
        if (rating && (rating.arrival_time || rating.departure_time)) {
          if (rating.arrival_time && rating.departure_time) {
            // Calculer la dur√©e
            const arrival = new Date(`2000-01-01T${rating.arrival_time}`);
            const departure = new Date(`2000-01-01T${rating.departure_time}`);
            const diffMs = departure - arrival;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffMinutes = Math.floor(
              (diffMs % (1000 * 60 * 60)) / (1000 * 60)
            );

            let durationText = "";
            if (diffHours > 0) {
              durationText = ` (${diffHours}h${
                diffMinutes > 0 ? diffMinutes : ""
              })`;
            } else {
              durationText = ` (${diffMinutes}min)`;
            }

            timingText = ` ‚Ä¢ ${rating.arrival_time} ‚Üí ${rating.departure_time}${durationText}`;
          } else if (rating.arrival_time && rating.still_present) {
            // En cours : seulement si c'est aujourd'hui
            const ratingDate = new Date(rating.created_at);
            const today = new Date();
            const isToday = ratingDate.toDateString() === today.toDateString();

            if (isToday) {
              timingText = ` ‚Ä¢ Depuis ${rating.arrival_time}`;
            } else {
              timingText = ` ‚Ä¢ Arriv√© √† ${rating.arrival_time}`;
            }
          } else if (rating.arrival_time) {
            timingText = ` ‚Ä¢ Arriv√© √† ${rating.arrival_time}`;
          }
        }

        return `
          <div class="text-sm text-gray-500">
            <div class="font-medium text-gray-700">${preciseDate}${timingText}</div>
            <div class="text-xs text-gray-400">${relativeTime}</div>
          </div>
        `;
      }

      function formatPresenceTiming(rating) {
        if (!rating.arrival_time && !rating.departure_time) return "";

        // D√©terminer si l'avis est du jour m√™me ou d'un jour pass√©
        const ratingDate = new Date(rating.created_at);
        const today = new Date();
        const isToday = ratingDate.toDateString() === today.toDateString();

        // Calculer la dur√©e de pr√©sence si on a les deux heures
        let durationText = "";
        if (rating.arrival_time && rating.departure_time) {
          const arrival = new Date(`2000-01-01T${rating.arrival_time}`);
          const departure = new Date(`2000-01-01T${rating.departure_time}`);
          const diffMs = departure - arrival;
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffMinutes = Math.floor(
            (diffMs % (1000 * 60 * 60)) / (1000 * 60)
          );

          if (diffHours > 0) {
            durationText = ` (${diffHours}h${
              diffMinutes > 0 ? diffMinutes : ""
            })`;
          } else {
            durationText = ` (${diffMinutes}min)`;
          }
        }

        let timingText = "";
        let timingIcon = "üïê";
        let badgeColor = "bg-blue-100 text-blue-800";

        if (rating.arrival_time && rating.departure_time) {
          // Arriv√©e + d√©part : toujours afficher la plage horaire
          timingText = `${rating.arrival_time} ‚Üí ${rating.departure_time}${durationText}`;
          timingIcon = "‚è∞";
          badgeColor = "bg-green-100 text-green-800";
        } else if (rating.arrival_time && rating.still_present) {
          // En cours : seulement si c'est aujourd'hui
          if (isToday) {
          timingText = `Depuis ${rating.arrival_time}`;
          timingIcon = "üî¥";
            badgeColor = "bg-red-100 text-red-800";
          } else {
            // Pour les jours pass√©s, afficher juste l'heure d'arriv√©e
            timingText = `Arriv√© √† ${rating.arrival_time}`;
            timingIcon = "üïê";
            badgeColor = "bg-gray-100 text-gray-700";
          }
        } else if (rating.arrival_time) {
          // Arriv√©e seule
          timingText = `Arriv√© √† ${rating.arrival_time}`;
          timingIcon = "üïê";
          badgeColor = "bg-blue-100 text-blue-800";
        }

        return timingText
          ? `
          <div class="text-right">
            <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded-full">
              ${timingIcon} ${timingText}
            </span>
                     </div>
                   `
          : "";
      }

      function formatQuickTags(quickTags) {
        if (!quickTags || quickTags.length === 0) return "";

        // Version simplifi√©e pour les performances
        const tagEmojis = {
          excellent: "üòç",
          bond√©: "üë•",
          calme: "üòå",
          bruyant: "üîä",
          famille: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶",
          cher: "üí∏",
          "bon-prix": "üí∞",
          "mal-organis√©": "ü§∑‚Äç‚ôÇÔ∏è",
          "bien-organis√©": "‚úÖ",
        };

        return `
          <div class="mb-4">
            <div class="flex flex-wrap gap-2">
              ${quickTags
                .map(
                  (tag) =>
                    `<span class="inline-flex items-center px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded-full">
                  ${tagEmojis[tag] || "üè∑Ô∏è"} ${
                      tag.charAt(0).toUpperCase() + tag.slice(1)
                    }
                </span>`
                )
                .join("")}
                     </div>
          </div>
        `;
      }

      function formatDetailedCriteria(detailedCriteria) {
        if (!detailedCriteria || Object.keys(detailedCriteria).length === 0)
          return "";

        // Version ultra-simplifi√©e pour les performances
        const criteriaLabels = {
          "sound-quality": "üéµ Qualit√© sonore",
          ambiance: "üé≠ Ambiance",
          organisation: "üìã Organisation",
          visibility: "üëÄ Visibilit√©",
          comfort: "ü™ë Confort",
          security: "üõ°Ô∏è S√©curit√©",
          "content-quality": "üìö Qualit√© contenu",
          "speaker-quality": "üé§ Orateur",
          accessibility: "‚ôø Accessibilit√©",
          networking: "ü§ù R√©seau",
          variety: "üé® Vari√©t√©",
          "food-quality": "üçî Restauration",
          cleanliness: "üßπ Propret√©",
          value: "üí∞ Rapport Q/P",
          "game-quality": "‚öΩ Qualit√© match",
          facilities: "üèüÔ∏è Installations",
          learning: "üìñ √âducatif",
          quality: "‚≠ê Qualit√©",
        };

        return `
          <div class="mb-4">
            <h4 class="text-sm font-medium text-gray-700 mb-2">Crit√®res d√©taill√©s :</h4>
            <div class="space-y-2">
              ${Object.entries(detailedCriteria)
                .map(([key, value]) => {
                  const label = criteriaLabels[key] || `üìä ${key}`;
                  return `
                  <div class="flex justify-between items-center bg-gray-50 p-2 rounded">
                    <span class="text-xs text-gray-700">${label}</span>
                    <span class="text-sm font-bold text-gray-900">${value}/5</span>
                  </div>`;
                })
                .join("")}
               </div>
           </div>
         `;
      }

      function formatContextInfo(rating) {
        const contextItems = [];

        if (rating.crowd_level) {
          const crowdLevels = [
            "Tr√®s vide",
            "Peu de monde",
            "Mod√©r√©",
            "Bond√©",
            "Tr√®s bond√©",
          ];
          const crowdText =
            crowdLevels[rating.crowd_level - 1] || `${rating.crowd_level}/5`;
          contextItems.push(`
            <div class="flex items-center space-x-1 min-w-0">
              <span class="flex-shrink-0">üë•</span>
              <span class="text-xs text-gray-600 flex-shrink-0">Affluence:</span>
              <span class="text-xs font-medium break-words">${crowdText}</span>
            </div>
          `);
        }

        if (rating.weather_conditions) {
          const weatherEmojis = {
            ensoleill√©: "‚òÄÔ∏è",
            nuageux: "‚òÅÔ∏è",
            pluvieux: "üåßÔ∏è",
            neigeux: "‚ùÑÔ∏è",
            venteux: "üí®",
            orageux: "‚õàÔ∏è",
          };
          contextItems.push(`
            <div class="flex items-center space-x-1 min-w-0">
              <span class="flex-shrink-0">${
                weatherEmojis[rating.weather_conditions] || "üå§Ô∏è"
              }</span>
              <span class="text-xs text-gray-600 flex-shrink-0">M√©t√©o:</span>
              <span class="text-xs font-medium break-words">${
                rating.weather_conditions
              }</span>
                   </div>
          `);
        }

        return contextItems.length > 0
          ? `
          <div class="flex flex-wrap gap-3 pt-3 border-t border-gray-200">
            ${contextItems.join("")}
                     </div>
                   `
          : "";
      }

      // Fermer le modal des avis
      function closeRatingsModal() {
        const modal = document.getElementById("ratings-modal");
        modal.classList.add("hidden");

        // R√©initialiser la position de la fen√™tre
        modal.style.position = "";
        modal.style.top = "";
        modal.style.left = "";
        modal.style.right = "";
        modal.style.width = "";
        modal.style.maxHeight = "";
        modal.style.overflowY = "";
        modal.style.zIndex = "";
        modal.style.backgroundColor = "";
        modal.style.backdropFilter = "";
      }

      // Fonction de fermeture simple - g√©r√©e par le HTML

      // Ouvrir le modal "Mes avis"
      async function openMyRatingsModal() {
        if (!currentUser || !authToken) {
          showNotification(
            "error",
            "Connexion requise",
            "Vous devez √™tre connect√© pour voir vos avis"
          );
          return;
        }

        setCurrentPage('my-ratings');
        document.getElementById("my-ratings-modal").classList.remove("hidden");
        await loadMyRatings();

        // Scroll automatiquement vers la fen√™tre sur mobile
        if (window.innerWidth <= 768) {
          setTimeout(() => {
            const modal = document.getElementById("my-ratings-modal");
            if (modal) {
              modal.scrollIntoView({
                behavior: "smooth",
                block: "start",
                inline: "nearest",
              });
            }
          }, 100);
        }
      }

      // Fermer le modal "Mes avis"
      function closeMyRatingsModal() {
        document.getElementById("my-ratings-modal").classList.add("hidden");
        // Retourner √† la page pr√©c√©dente
        const previousPage = goBackToPreviousPage();
        if (previousPage === 'events') {
          showEventsSection();
        }
      }

      // Modal de r√©cup√©ration de mot de passe
      function showForgotPasswordModal() {
        document
          .getElementById("forgot-password-modal")
          .classList.remove("hidden");
      }

      function closeForgotPasswordModal() {
        document
          .getElementById("forgot-password-modal")
          .classList.add("hidden");
        document.getElementById("forgot-password-form").reset();
      }

      // G√©rer la r√©cup√©ration de mot de passe
      async function handleForgotPassword(event) {
        event.preventDefault();

        const email = document.getElementById("forgot-email").value;

        try {
          const response = await fetch(
            `${API_BASE}/auth/simple-password-reset`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ email }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            // Afficher le code et le lien directement dans l'application
            showCodeModal(data.code, data.resetUrl, data.userEmail);
            closeForgotPasswordModal();
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Impossible de g√©n√©rer le code de r√©cup√©ration"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Afficher la modal avec le code de r√©cup√©ration
      function showCodeModal(code, resetUrl, userEmail) {
        const modal = document.createElement("div");
        modal.className =
          "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4";
        modal.innerHTML = `
          <div class="bg-white rounded-lg max-w-md w-full p-6 relative" onclick="event.stopPropagation()">
            <button onclick="closeCodeModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
            
            <div class="text-center">
              <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
              </div>
              
              <h3 class="text-xl font-bold text-gray-900 mb-2">üîë Code de r√©cup√©ration g√©n√©r√© !</h3>
              <p class="text-gray-600 mb-4">Pour ${userEmail}</p>
              
              <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-4">
                <p class="text-sm text-blue-800 mb-2">Votre code de r√©cup√©ration :</p>
                <div class="text-2xl font-mono font-bold text-blue-900 bg-blue-100 px-4 py-2 rounded border-2 border-blue-300">
                  ${code}
                </div>
              </div>
              
              <div class="bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4">
                <p class="text-sm text-gray-700 mb-2">Ou cliquez sur ce lien :</p>
                <a href="${resetUrl}" class="text-blue-600 hover:text-blue-800 underline text-sm break-all">
                  ${resetUrl}
                </a>
              </div>
              
              <p class="text-xs text-gray-500">‚è∞ Ce code expire dans 1 heure</p>
              
              <button onclick="closeCodeModal()" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                Compris !
              </button>
            </div>
          </div>
        `;

        modal.onclick = closeCodeModal;
        document.body.appendChild(modal);
      }

      function closeCodeModal() {
        const modal = document.querySelector(
          ".fixed.inset-0.bg-black.bg-opacity-50"
        );
        if (modal) {
          modal.remove();
        }
      }

      // Fonction pour afficher la section de r√©initialisation
      function showRecoveryCodeSection() {
        showSection("recovery-code-section");
      }

      // Fonction pour r√©initialiser le mot de passe avec le code de r√©cup√©ration
      async function resetPasswordWithRecoveryCode(event) {
        event.preventDefault();

        const email = document.getElementById("recovery-email").value;
        const recoveryCode = document.getElementById("recovery-code").value;
        const newPassword = document
          .getElementById("new-password")
          .value.trim();
        const confirmPassword = document
          .getElementById("confirm-new-password")
          .value.trim();

        // V√©rifier que les mots de passe correspondent
        if (newPassword !== confirmPassword) {
          showNotification(
            "error",
            "Erreur",
            "Les mots de passe ne correspondent pas"
          );
          return;
        }

        // V√©rifier la longueur du mot de passe
        if (newPassword.length < 6) {
          showNotification(
            "error",
            "Erreur",
            "Le mot de passe doit contenir au moins 6 caract√®res"
          );
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/auth`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              action: "reset",
              email: email,
              recoveryCode: recoveryCode,
              newPassword: newPassword,
            }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification(
              "success",
              "Mot de passe r√©initialis√© !",
              data.message ||
                "Vous pouvez maintenant vous connecter avec votre nouveau mot de passe."
            );

            // Rediriger vers la page de connexion
            setTimeout(() => {
              showSection("login");
            }, 2000);
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Erreur lors de la r√©initialisation"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Fonction pour basculer la visibilit√© des mots de passe
      function togglePasswordVisibility(inputId, buttonId) {
        const input = document.getElementById(inputId);
        const button = document.getElementById(buttonId);

        if (input.type === "password") {
          input.type = "text";
          button.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
            </svg>
          `;
        } else {
          input.type = "password";
          button.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
          `;
        }
      }

      // G√©rer la r√©initialisation de mot de passe
      async function resetPassword(event) {
        event.preventDefault();

        console.log("üîß DEBUG - D√©but de resetPassword");
        console.log("üîß DEBUG - DOM charg√©:", document.readyState);

        const tokenInput = document.getElementById("reset-token");
        const newPasswordInput = document.getElementById("reset-password");
        const confirmPasswordInput = document.getElementById(
          "reset-password-confirm"
        );

        console.log("üîß DEBUG - √âl√©ments trouv√©s:");
        console.log("üîß DEBUG - tokenInput:", tokenInput);
        console.log("üîß DEBUG - newPasswordInput:", newPasswordInput);
        console.log("üîß DEBUG - confirmPasswordInput:", confirmPasswordInput);

        // V√©rifier que tous les √©l√©ments existent
        if (!tokenInput || !newPasswordInput || !confirmPasswordInput) {
          console.error("‚ùå ERREUR - √âl√©ments manquants:", {
            tokenInput: !!tokenInput,
            newPasswordInput: !!newPasswordInput,
            confirmPasswordInput: !!confirmPasswordInput,
          });
          showNotification(
            "error",
            "Erreur",
            "Erreur de chargement du formulaire. Veuillez recharger la page."
          );
          return;
        }

        const token = tokenInput.value;
        const newPassword = newPasswordInput.value.trim();
        const confirmPassword = confirmPasswordInput.value.trim();

        // Debug pour voir les valeurs
        console.log("Nouveau mot de passe:", `"${newPassword}"`);
        console.log("Confirmation:", `"${confirmPassword}"`);
        console.log("Longueur nouveau:", newPassword.length);
        console.log("Longueur confirmation:", confirmPassword.length);
        console.log("Correspondent:", newPassword === confirmPassword);

        // V√©rifier que les mots de passe correspondent
        if (newPassword !== confirmPassword) {
          showNotification(
            "error",
            "Erreur",
            `Les mots de passe ne correspondent pas. Nouveau: "${newPassword}" (${newPassword.length} chars), Confirmation: "${confirmPassword}" (${confirmPassword.length} chars)`
          );
          return;
        }

        // V√©rifier la longueur du mot de passe
        if (newPassword.length < 6) {
          showNotification(
            "error",
            "Erreur",
            "Le mot de passe doit contenir au moins 6 caract√®res"
          );
          return;
        }

        try {
          const response = await fetch(
            `${API_BASE}/test/reset-password-simple`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                token: token,
                newPassword: newPassword,
              }),
            }
          );

          const data = await response.json();

          if (response.ok) {
            showNotification(
              "success",
              "Mot de passe r√©initialis√© !",
              data.message ||
                "Vous pouvez maintenant vous connecter avec votre nouveau mot de passe."
            );

            // Rediriger vers la page de connexion
            setTimeout(() => {
              showSection("login");
              // R√©initialiser le formulaire
              event.target.reset();
            }, 2000);
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Impossible de r√©initialiser le mot de passe"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Modal "Mes √©v√©nements" - VERSION COMPL√àTE
      async function openMyEventsModal() {
        setCurrentPage('my-events');
        document.getElementById("my-events-modal").classList.remove("hidden");
        await loadMyEvents();

        // Scroll automatiquement vers la fen√™tre sur mobile
        if (window.innerWidth <= 768) {
          setTimeout(() => {
            const modal = document.getElementById("my-events-modal");
            if (modal) {
              modal.scrollIntoView({
                behavior: "smooth",
                block: "start",
                inline: "nearest",
              });
            }
          }, 100);
        }
      }

      function closeMyEventsModal() {
        document.getElementById("my-events-modal").classList.add("hidden");
        // Retourner √† la page pr√©c√©dente
        const previousPage = goBackToPreviousPage();
        if (previousPage === 'events') {
          showEventsSection();
        }
      }

      // Charger les √©v√©nements de l'utilisateur
      async function loadMyEvents() {
        try {
          const response = await fetch(`${API_BASE}/users`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ action: "my-events" }),
          });

          if (response.ok) {
            const events = await response.json();

            // Pr√©charger les images en arri√®re-plan
            setTimeout(() => preloadImages(events), 50);

            // Lazy loading optimis√© pour mobile
            if (window.innerWidth <= 768) {
              // Mobile : d√©lai plus long pour √©viter les lags
              setTimeout(() => {
            displayMyEvents(events);
              }, 150);
            } else {
              // Desktop : d√©lai normal
              setTimeout(() => {
                displayMyEvents(events);
              }, 100);
            }
          } else {
            console.error("Erreur chargement √©v√©nements:", response.status);
            document.getElementById("my-events-list").innerHTML = `
              <div class="text-center py-8">
                <p class="text-red-500">‚ùå Erreur de chargement des √©v√©nements</p>
                     </div>
            `;
          }
        } catch (error) {
          console.error("Erreur:", error);
          document.getElementById("my-events-list").innerHTML = `
            <div class="text-center py-8">
              <p class="text-red-500">‚ùå Erreur de connexion au serveur</p>
                     </div>
          `;
        }
      }

      // Afficher les √©v√©nements de l'utilisateur
      function displayMyEvents(events) {
        const content = document.getElementById("my-events-list");

        if (events.length === 0) {
          content.innerHTML = `
            <div class="text-center py-12">
              <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-purple-100 to-blue-100 rounded-full flex items-center justify-center">
                <svg class="w-12 h-12 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              </div>
              <h3 class="text-2xl font-bold text-gray-900 mb-2">Aucun √©v√©nement cr√©√©</h3>
              <p class="text-gray-600 mb-6">Cr√©ez votre premier √©v√©nement pour le voir ici !</p>
              <button
                onclick="closeMyEventsModal(); showSection('home')"
                class="btn-gradient text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition-all duration-300"
              >
                üé™ Cr√©er un √©v√©nement
              </button>
                     </div>
          `;
          return;
        }

        content.innerHTML = `
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            ${events
              .map(
                (event) => `
              <div class="event-card-simple group">
                <!-- Header avec image et statut -->
                <div class="relative mb-4">
                  ${
                    event.photos && event.photos.length > 0
                      ? `
                    <img src="${event.photos[0]}" 
                         class="w-full h-48 object-contain bg-gray-100 rounded-t-lg" 
                         alt="Photo √©v√©nement" 
                         loading="lazy" decoding="async"
                         onerror="this.style.display='none'">
                  `
                      : `
                    <div class="w-full h-48 bg-gradient-to-br from-purple-100 to-blue-100 rounded-t-lg flex items-center justify-center">
                      <svg class="w-16 h-16 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                      </svg>
                    </div>
                  `
                  }
                  
                  <!-- Badge de statut -->
                  <div class="absolute top-3 right-3">
                    ${(() => {
                      const status = getEventStatus(event);
                      return `<span class="status-badge ${status.color}">
                        ${status.icon} ${status.text}
                      </span>`;
                    })()}
                  </div>
                </div>

                <!-- Contenu principal -->
                <div class="p-6">
                  <!-- Titre et cat√©gorie -->
                  <div class="mb-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-2 group-hover:text-purple-600 transition-colors">
                      ${event.title}
                    </h3>
                    ${
                      event.category
                        ? `
                      <span class="category-badge category-${event.category.toLowerCase()}">
                        üè∑Ô∏è ${event.category}
                      </span>
                    `
                        : ""
                    }
                  </div>

                  <!-- Informations principales -->
                  <div class="space-y-3 mb-6">
                    <!-- Date -->
                    <div class="flex items-center text-gray-600">
                      <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-gray-500">Date</p>
                        <p class="text-gray-900 font-semibold">${formatEventDateRange(
                        event
                        )}</p>
                      </div>
                    </div>

                    <!-- Lieu -->
                    <div class="flex items-center text-gray-600">
                      <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-gray-500">Lieu</p>
                        <p class="text-gray-900 font-semibold">${
                        event.location || "Non sp√©cifi√©"
                        }</p>
                      </div>
                    </div>

                    <!-- Prix -->
                    <div class="flex items-center text-gray-600">
                      <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                        <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                      </div>
                      <div>
                        <p class="text-sm font-medium text-gray-500">Prix</p>
                        <p class="text-gray-900 font-semibold">
                          ${
                            event.price_is_free
                              ? "üÜì Gratuit"
                              : `‚Ç¨${event.price_amount || 0}`
                          }
                        </p>
                      </div>
                    </div>

                    <!-- Note moyenne -->
                      ${
                        event.rating_average && event.rating_average > 0
                          ? `
                      <div class="flex items-center text-gray-600">
                        <div class="w-8 h-8 bg-yellow-100 rounded-full flex items-center justify-center mr-3">
                          <svg class="w-4 h-4 text-yellow-600" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                          </svg>
                        </div>
                        <div>
                          <p class="text-sm font-medium text-gray-500">Note moyenne</p>
                          <p class="text-gray-900 font-semibold">${formatRating(
                              event
                          )}</p>
                        </div>
                      </div>
                    `
                          : ""
                      }
                     </div>

                  <!-- Description -->
                  ${
                    event.description
                      ? `
                    <div class="mb-6">
                      <p class="text-gray-600 text-sm leading-relaxed line-clamp-3">
                        ${event.description}
                      </p>
                  </div>
                  `
                      : ""
                  }

                  <!-- Actions -->
                  <div class="flex space-x-3">
                    <button 
                      onclick="editEvent(${event.id})" 
                      class="flex-1 btn-gradient text-white py-2 px-4 rounded-lg font-medium hover:shadow-lg transition-all duration-300 flex items-center justify-center"
                    >
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                      </svg>
                      Modifier
                    </button>
                    <button 
                      onclick="deleteEvent(${event.id})" 
                      class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition-all duration-300 flex items-center justify-center"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                </div>
               </div>
             `
              )
              .join("")}
           </div>
         `;
      }

      // Variables pour l'√©dition d'√©v√©nement
      let currentEditingEventId = null;
      let editEventPhotos = [];

      // Fonctions d'actions sur les √©v√©nements
      async function editEvent(eventId) {
        // Fermer le modal "Mes √©v√©nements" d'abord
        closeMyEventsModal();

        currentEditingEventId = eventId;

        try {
          // R√©cup√©rer les d√©tails de l'√©v√©nement
          const response = await fetch(`${API_BASE}/events`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ action: "get", id: eventId }),
          });

          if (response.ok) {
            const event = await response.json();
            fillEditEventForm(event);
            document
              .getElementById("edit-event-modal")
              .classList.remove("hidden");
            
            // Ajouter toutes les m√©thodes de fermeture standard
            setupEditEventModalCloseMethods();
          } else {
            alert("‚ùå Erreur lors du chargement de l'√©v√©nement");
          }
        } catch (error) {
          console.error("Erreur:", error);
          alert("‚ùå Erreur de connexion au serveur");
        }
      }

      // Pr√©-remplir le formulaire d'√©dition
      function fillEditEventForm(event) {
        document.getElementById("edit-event-title").value = event.title || "";
        document.getElementById("edit-event-description").value =
          event.description || "";
        document.getElementById("edit-event-category").value =
          event.category || "";
        document.getElementById("edit-event-address").value =
          event.location_address || "";
        document.getElementById("edit-event-city").value =
          event.location_city || "";

        // Gestion des dates
        if (event.date_start) {
          const startDate = new Date(event.date_start)
            .toISOString()
            .slice(0, 16);
          document.getElementById("edit-event-start-date").value = startDate;
        }
        if (event.date_end) {
          const endDate = new Date(event.date_end).toISOString().slice(0, 16);
          document.getElementById("edit-event-end-date").value = endDate;
        }

        // Gestion du prix
        const isFree = event.price_is_free;
        document.getElementById("edit-event-free").checked = isFree;
        document.getElementById("edit-event-price").value = isFree
          ? ""
          : event.price_amount || "";
        document.getElementById("edit-event-price").disabled = isFree;

        // Gestion des photos
        editEventPhotos = event.photos ? [...event.photos] : [];
        displayEditEventPhotos();
      }

      // Afficher les photos dans le formulaire d'√©dition
      function displayEditEventPhotos() {
        const container = document.getElementById(
          "edit-event-photos-container"
        );

        if (editEventPhotos.length === 0) {
          container.innerHTML = `
            <div class="text-center py-8 border-2 border-dashed border-gray-300 rounded-lg">
              <p class="text-gray-500">Aucune photo ajout√©e</p>
            </div>
          `;
          return;
        }

        container.innerHTML = `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            ${editEventPhotos
              .map(
                (photo, index) => `
              <div class="relative group">
                <img src="${photo}" class="w-full h-32 object-contain bg-gray-100 rounded-lg border" alt="Photo ${
                  index + 1
                }" 
                     loading="lazy" decoding="async"
                     onerror="this.src='https://via.placeholder.com/400x300/E5E7EB/6B7280?text=Image+non+trouv√©e'" />
                <button
                  type="button"
                  onclick="removeEditPhoto(${index})"
                  class="absolute top-2 right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity"
                >
                  ‚úï
                </button>
                <div class="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white text-xs px-2 py-1 rounded">
                  Photo ${index + 1}
                 </div>
               </div>
             `
              )
              .join("")}
           </div>
         `;
      }

      // Ajouter une photo √† l'√©dition
      function addEditPhoto() {
        const urlInput = document.getElementById("edit-new-photo-url");
        const url = urlInput.value.trim();

        if (!url) {
          alert("‚ùå Veuillez entrer une URL de photo");
          return;
        }

        if (!isValidUrl(url)) {
          alert("‚ùå Veuillez entrer une URL valide");
          return;
        }

        if (editEventPhotos.includes(url)) {
          alert("‚ùå Cette photo est d√©j√† ajout√©e");
          return;
        }

        editEventPhotos.push(url);
        urlInput.value = "";
        displayEditEventPhotos();
      }

      // Supprimer une photo de l'√©dition
      function removeEditPhoto(index) {
        if (confirm("Voulez-vous supprimer cette photo ?")) {
          editEventPhotos.splice(index, 1);
          displayEditEventPhotos();
        }
      }

      // Fermer le modal d'√©dition
      function closeEditEventModal() {
        document.getElementById("edit-event-modal").classList.add("hidden");
        currentEditingEventId = null;
        editEventPhotos = [];
        document.getElementById("edit-event-form").reset();
      }

      // G√©rer l'√©v√©nement gratuit
      document.addEventListener("DOMContentLoaded", function () {
        const freeCheckbox = document.getElementById("edit-event-free");
        const priceInput = document.getElementById("edit-event-price");

        if (freeCheckbox && priceInput) {
          freeCheckbox.addEventListener("change", function () {
            if (this.checked) {
              priceInput.value = "";
              priceInput.disabled = true;
            } else {
              priceInput.disabled = false;
            }
          });
        }
      });

      // Soumettre les modifications
      document.addEventListener("DOMContentLoaded", function () {
        const editForm = document.getElementById("edit-event-form");
        if (editForm) {
          editForm.addEventListener("submit", handleEditEventSubmit);
        }
      });

      async function handleEditEventSubmit(e) {
        e.preventDefault();

        if (!currentEditingEventId) {
          alert("‚ùå Erreur : ID d'√©v√©nement manquant");
          return;
        }

        const formData = {
          title: document.getElementById("edit-event-title").value.trim(),
          description: document
            .getElementById("edit-event-description")
            .value.trim(),
          category: document.getElementById("edit-event-category").value,
          location_address: document
            .getElementById("edit-event-address")
            .value.trim(),
          location_city: document
            .getElementById("edit-event-city")
            .value.trim(),
          date_start: document.getElementById("edit-event-start-date").value,
          date_end: document.getElementById("edit-event-end-date").value,
          price_is_free: document.getElementById("edit-event-free").checked,
          price_amount: document.getElementById("edit-event-free").checked
            ? 0
            : parseFloat(document.getElementById("edit-event-price").value) ||
              0,
          photos: editEventPhotos,
        };

        // Validation
        if (
          !formData.title ||
          !formData.category ||
          !formData.location_address ||
          !formData.location_city ||
          !formData.date_start
        ) {
          alert("‚ùå Veuillez remplir tous les champs obligatoires");
          return;
        }

        // Validation de date d√©sactiv√©e - on permet les dates pass√©es
        console.log("üìÖ Date de d√©but:", formData.date_start);

        if (
          formData.date_end &&
          new Date(formData.date_end) <= new Date(formData.date_start)
        ) {
          alert("‚ùå La date de fin doit √™tre post√©rieure √† la date de d√©but");
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/events`, {
            method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
            body: JSON.stringify({
              action: "update",
              id: currentEditingEventId,
              ...formData,
            }),
          });

          if (response.ok) {
            alert("‚úÖ √âv√©nement modifi√© avec succ√®s !");
            closeEditEventModal();
            // Recharger la liste des √©v√©nements
            await loadMyEvents();
          } else {
            const error = await response.json();
            alert(`‚ùå Erreur : ${error.error || "Modification √©chou√©e"}`);
          }
        } catch (error) {
          console.error("Erreur:", error);
          alert("‚ùå Erreur de connexion au serveur");
        }
      }

      async function duplicateEvent(eventId) {
        if (confirm("Voulez-vous dupliquer cet √©v√©nement ?")) {
          alert(
            "üìã Duplication en cours...\n\nFonctionnalit√© en d√©veloppement..."
          );
        }
      }

      async function deleteEvent(eventId) {
        if (
          confirm(
            "‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer cet √©v√©nement ?\n\nCette action est irr√©versible !"
          )
        ) {
          alert(
            "üóëÔ∏è Suppression en cours...\n\nFonctionnalit√© en d√©veloppement..."
          );
        }
      }

      // Formater une date d'√©v√©nement
      function formatEventDate(dateStr) {
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString("fr-FR", {
            weekday: "long",
            year: "numeric",
            month: "long",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch (e) {
          return dateStr;
        }
      }

      // Charger les avis de l'utilisateur connect√©
      async function loadMyRatings() {
        try {
          const response = await fetch(`${API_BASE}/users`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ action: "my-ratings" }),
          });

          const data = await response.json();

          if (response.ok) {
            // Pr√©charger les images en arri√®re-plan
            setTimeout(
              () =>
                preloadImages(
                  data.map((rating) => ({ photos: [rating.event_photo] }))
                ),
              50
            );

            // Lazy loading optimis√© pour mobile
            if (window.innerWidth <= 768) {
              // Mobile : d√©lai plus long pour √©viter les lags
              setTimeout(() => {
            displayMyRatings(data);
              }, 150);
            } else {
              // Desktop : d√©lai normal
              setTimeout(() => {
                displayMyRatings(data);
              }, 50);
            }
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Impossible de charger vos avis"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Afficher les avis de l'utilisateur
      function displayMyRatings(ratings) {
        const content = document.getElementById("my-ratings-content");

        if (ratings.length === 0) {
          content.innerHTML = `
            <div class="text-center py-12">
              <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-full flex items-center justify-center">
                <svg class="w-12 h-12 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
              </svg>
              </div>
              <h3 class="text-2xl font-bold text-gray-900 mb-2">Aucun avis pour le moment</h3>
              <p class="text-gray-600 mb-6">Notez votre premier √©v√©nement pour voir vos avis ici !</p>
            </div>
          `;
          return;
        }

        content.innerHTML = `
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            ${ratings
              .map(
                (rating) => `
              <div class="bg-white border border-gray-200 rounded-lg overflow-hidden shadow-sm hover:shadow-md transition-shadow duration-200">
                <!-- Photo de l'√©v√©nement en grand -->
                <div class="relative h-56 bg-gradient-to-br from-yellow-100 to-orange-100">
                  <div id="event-photo-${rating.id}" class="w-full h-full flex items-center justify-center">
                    <svg class="w-20 h-20 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                    </svg>
                      </div>
                  
                  <!-- Note dans le coin -->
                  <div class="absolute top-3 right-3 bg-white bg-opacity-90 backdrop-blur-sm rounded-lg px-3 py-1 flex items-center space-x-1">
                    <span class="text-yellow-500">‚≠ê</span>
                    <span class="text-sm font-bold text-gray-700">${rating.overall_rating}/5</span>
                    </div>
                  </div>

                <!-- Contenu de l'avis -->
                <div class="p-6">
                  <!-- Titre et date -->
                  <div class="mb-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${rating.event_title}</h3>
                    <div class="text-sm text-gray-500">
                      <div class="font-medium text-gray-700">${formatRatingDate(rating.created_at, rating)}</div>
                  </div>
                </div>

                <!-- Tags rapides -->
                ${formatQuickTags(rating.quick_tags)}

                <!-- Commentaire -->
                  ${rating.comment ? `
                    <div class="mb-4">
                    <div class="flex items-start space-x-2">
                        <span class="text-blue-500 text-lg">üí¨</span>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 flex-1">
                          <p class="text-sm text-gray-700">"${rating.comment}"</p>
                    </div>
                     </div>
                    </div>
                  ` : ''}

                  <!-- Crit√®res d√©taill√©s -->
                  ${formatDetailedCriteria(rating.detailed_criteria)}

                <!-- Informations contextuelles -->
                ${formatContextInfo(rating)}
                  
                  <!-- Actions -->
                  <div class="flex gap-3 mt-6">
                    <button
                      onclick="editRating(${rating.id})"
                      class="flex-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all duration-200 flex items-center justify-center space-x-2"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                      </svg>
                      <span>Modifier</span>
                    </button>
                    <button
                      onclick="deleteRating(${rating.id})"
                      class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition-colors"
                    >
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                </div>
               </div>
             `
              )
              .join("")}
           </div>
         `;

        // Pr√©charger toutes les images pour √©viter les lags
        const photoUrls = ratings
          .map(rating => rating.event_photo)
          .filter(url => url);
        
        if (photoUrls.length > 0) {
          preloadImages(photoUrls);
        }

        // Charger les photos pour chaque √©v√©nement
        ratings.forEach((rating) => {
          loadEventPhotoForDisplay(rating.event_id, `event-photo-${rating.id}`);
        });
      }

      // Charger et afficher une photo d'√©v√©nement dans la liste
      async function loadEventPhotoForDisplay(eventId, containerId) {
        try {
          const response = await fetch(`${API_BASE}/events`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ action: "get", id: eventId }),
          });

          if (response.ok) {
            const event = await response.json();
            const photos = event.photos || event.data?.photos || [];
            const container = document.getElementById(containerId);

            if (container && photos.length > 0) {
              // Pr√©charger l'image pour √©viter les lags
              const img = new Image();
              img.onload = () => {
              container.innerHTML = `
                  <img 
                    src="${photos[0]}" 
                     alt="Photo √©v√©nement"
                    class="w-full h-full object-cover"
                    loading="lazy"
                    decoding="async"
                  />
                `;
              };
              img.src = photos[0];
            }
          }
        } catch (error) {
          console.error("Erreur chargement photo:", error);
        }
      }

      // Modifier un avis
      async function editRating(ratingId) {
        try {
          // Fermer le modal "Mes avis" d'abord
          closeMyRatingsModal();

          // R√©cup√©rer les d√©tails du rating
          const response = await fetch(`${API_BASE}/ratings`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ action: "get", ratingId: ratingId }),
          });

          if (response.ok) {
            const rating = await response.json();

            // Pr√©-remplir le modal de notation avec les donn√©es existantes
            await prepareEditRatingModal(rating);
          } else {
            showNotification(
              "error",
              "Erreur",
              "Impossible de charger l'avis √† modifier"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Pr√©parer le modal pour √©diter un avis
      async function prepareEditRatingModal(rating) {
        // Marquer qu'on est en mode √©dition
        window.editingRatingId = rating.id;

        // Ouvrir le modal de notation
        openRatingModal(rating.event_id);

        // Attendre que le modal soit ouvert
        setTimeout(() => {
          // SUPPRIM√â : Pas de modification du titre et photos dans "Mes avis"
          // On modifie seulement l'avis, pas l'√©v√©nement lui-m√™me

          // Pr√©-remplir les champs avec les donn√©es existantes

          // Note globale
          const overallRating = document.getElementById("overall-rating");
          if (overallRating && rating.overall_rating) {
            overallRating.value = rating.overall_rating;
            updateRatingValue("overall-rating");
          }

          // Timing de pr√©sence
          if (rating.arrival_time) {
            const arrivalTime = document.getElementById("arrival-time");
            if (arrivalTime) arrivalTime.value = rating.arrival_time;
          }

          if (rating.departure_time) {
            const departureTime = document.getElementById("departure-time");
            if (departureTime) departureTime.value = rating.departure_time;
          }

          const stillPresent = document.getElementById("still-present");
          if (stillPresent)
            stillPresent.checked = rating.still_present || false;
          toggleDepartureTime();

          // Tags rapides
          selectedTags = rating.quick_tags ? [...rating.quick_tags] : [];
          updateTagButtons();

          // Crit√®res d√©taill√©s
          if (rating.detailed_criteria) {
            activeCriteria = { ...rating.detailed_criteria };

            // Afficher la section des crit√®res d√©taill√©s
            const detailedSection =
              document.getElementById("detailed-criteria");
            if (detailedSection.classList.contains("hidden")) {
              toggleDetailedCriteria();
            }

            // Cocher et d√©finir les valeurs des crit√®res
            Object.entries(rating.detailed_criteria).forEach(
              ([criterionId, value]) => {
                const checkbox = document.querySelector(
                  `[data-criterion="${criterionId}"] .criterion-checkbox`
                );
                if (checkbox) {
                  checkbox.checked = true;
                  toggleCriterionRating(criterionId);

                  const slider = document.getElementById(criterionId);
                  if (slider) {
                    slider.value = value;
                    updateCriterionValue(criterionId);
                  }
                }
              }
            );
          }

          // Contexte (crowd level, weather)
          if (rating.crowd_level) {
            const crowdLevel = document.getElementById("crowd-level");
            if (crowdLevel) {
              crowdLevel.value = rating.crowd_level;
              updateCrowdLevel();
            }
          }

          if (rating.weather_conditions) {
            const weather = document.getElementById("weather-conditions");
            if (weather) weather.value = rating.weather_conditions;
          }

          // Commentaire
          if (rating.comment) {
            const comment = document.getElementById("rating-comment");
            if (comment) comment.value = rating.comment;
          }

          // Modifier le titre du modal
          const modalTitle = document.querySelector("#rating-modal h2");
          if (modalTitle) {
            modalTitle.textContent = "‚úèÔ∏è Modifier votre avis";
          }

          // Modifier le texte du bouton
          const submitBtn = document.querySelector(
            '#rating-modal button[type="submit"]'
          );
          if (submitBtn) {
            submitBtn.textContent = "Mettre √† jour l'avis";
          }
        }, 300);
      }

      // Supprimer un avis
      async function deleteRating(ratingId) {
        if (
          !confirm(
            "√ätes-vous s√ªr de vouloir supprimer cet avis ? Cette action est irr√©versible."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/ratings`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ action: "delete", ratingId: ratingId }),
          });

          const data = await response.json();

          if (response.ok) {
            showNotification(
              "success",
              "Supprim√©",
              "Votre avis a √©t√© supprim√© avec succ√®s"
            );
            // Recharger la liste des avis
            await loadMyRatings();
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Impossible de supprimer l'avis"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Inscription
      async function register(event) {
        event.preventDefault();

        const email = document.getElementById("register-email").value;
        const password = document.getElementById("register-password").value;
        const rememberMe = document.getElementById(
          "remember-me-register"
        ).checked;

        const formData = {
          username: document.getElementById("register-username").value,
          email: email,
          password: password,
          firstName: document.getElementById("register-firstname").value,
          lastName: document.getElementById("register-lastname").value,
          recoveryCode: document.getElementById("register-recovery-code").value,
        };

        try {
          const response = await fetch(`${API_BASE}/auth`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ ...formData, action: "register" }),
          });

          const data = await response.json();

          if (response.ok) {
            currentUser = data.user;
            authToken = data.token;
            localStorage.setItem("authToken", authToken);

            // D√©marrer le timer d'inactivit√©
            resetInactivityTimer();

            // Sauvegarder les identifiants si demand√©
            if (rememberMe) {
              saveCredentials(email, password);
            }

            showNotification(
              "success",
              "Compte cr√©√© !",
              `Bienvenue ${formData.firstName} ${formData.lastName} ! Votre code de r√©cup√©ration a √©t√© enregistr√©.`
            );

            event.target.reset();
            showSection("home");
            updateNavigation();
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Erreur lors de la cr√©ation du compte"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Connexion
      async function login(event) {
        event.preventDefault();

        const email = document.getElementById("login-email").value;
        const password = document.getElementById("login-password").value;
        const rememberMe = document.getElementById("remember-me-login").checked;

        const formData = {
          email: email,
          password: password,
        };

        try {
          const response = await fetch(`${API_BASE}/auth`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ ...formData, action: "login" }),
          });

          const data = await response.json();

          if (response.ok) {
            currentUser = data.user;
            authToken = data.token;
            localStorage.setItem("authToken", authToken);

            // D√©marrer le timer d'inactivit√©
            resetInactivityTimer();

            // Sauvegarder les identifiants si demand√©
            if (rememberMe) {
              saveCredentials(email, password);
            }

            showNotification(
              "success",
              "Connexion r√©ussie !",
              `Bienvenue ${data.user.firstName} !`
            );

            event.target.reset();
            showSection("home");
            updateNavigation();
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Email ou mot de passe incorrect"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // D√©connexion
      function logout() {
        currentUser = null;
        authToken = null;
        localStorage.removeItem("authToken");

        // Arr√™ter le timer d'inactivit√©
        clearTimeout(inactivityTimer);

        // Optionnel : demander si effacer les identifiants sauvegard√©s
        const saved = loadSavedCredentials();
        if (
          saved &&
          confirm("Voulez-vous aussi effacer vos identifiants sauvegard√©s ?")
        ) {
          clearSavedCredentials();
        }

        showNotification(
          "success",
          "D√©connexion",
          "Vous √™tes maintenant d√©connect√©"
        );
        showSection("home");
        updateNavigation();
      }

      // Cr√©er un √©v√©nement
      // Variables pour la d√©tection de doublons
      let duplicateCheckTimeout = null;
      let lastCheckedTitle = "";

      // Fonction pour v√©rifier les doublons en temps r√©el
      async function checkDuplicatesRealTime() {
        const titleInput = document.getElementById("event-title");
        const title = titleInput.value.trim();

        // Ne pas v√©rifier si moins de 3 caract√®res ou si le titre n'a pas chang√©
        if (title.length < 3 || title === lastCheckedTitle) {
          hideDuplicateSuggestions();
          return;
        }

        // Debounce: attendre 500ms apr√®s la derni√®re frappe
        if (duplicateCheckTimeout) {
          clearTimeout(duplicateCheckTimeout);
        }

        duplicateCheckTimeout = setTimeout(async () => {
          lastCheckedTitle = title;
          await checkForDuplicates(title);
        }, 500);
      }

      // Fonction pour appeler l'API de d√©tection de doublons
      async function checkForDuplicates(title) {
        try {
          const dateInput = document.getElementById("event-start");
          const cityInput = document.getElementById("event-city");

          const params = new URLSearchParams({
            title: title,
          });

          if (dateInput && dateInput.value) {
            params.append("date_start", dateInput.value);
          }

          if (cityInput && cityInput.value) {
            params.append("location_city", cityInput.value);
          }

          const response = await fetch(
            `${API_BASE}/events/check-duplicates?${params}`
          );

          if (response.ok) {
            const data = await response.json();
            if (data.duplicates && data.duplicates.length > 0) {
              showDuplicateSuggestions(data.duplicates);
            } else {
              hideDuplicateSuggestions();
            }
          } else {
            hideDuplicateSuggestions();
          }
        } catch (error) {
          console.error("Erreur lors de la v√©rification des doublons:", error);
          hideDuplicateSuggestions();
        }
      }

      // Afficher les suggestions de doublons
      function showDuplicateSuggestions(duplicates) {
        const suggestionsContainer = document.getElementById(
          "duplicate-suggestions"
        );
        const duplicateList = document.getElementById("duplicate-list");

        if (!suggestionsContainer || !duplicateList) return;

        let html = "";
        duplicates.forEach((duplicate) => {
          const confidence = duplicate.confidence;
          const confidenceColor =
            confidence >= 80
              ? "text-red-600"
              : confidence >= 60
              ? "text-orange-600"
              : "text-yellow-600";
          const confidenceIcon =
            confidence >= 80 ? "üö®" : confidence >= 60 ? "‚ö†Ô∏è" : "üí°";

          html += `
            <div class="mb-3 p-2 bg-white rounded border border-yellow-300">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <div class="flex items-center">
                    <span class="mr-2">${confidenceIcon}</span>
                    <span class="font-medium text-gray-900">${
                      duplicate.title
                    }</span>
                    <span class="ml-2 text-xs ${confidenceColor} font-medium">${confidence}% similaire</span>
                  </div>
                  <div class="mt-1 text-xs text-gray-600">
                    üìÖ ${formatEventDate(duplicate.date_start)} ‚Ä¢ üìç ${
            duplicate.location_city
          }
                  </div>
                  <div class="mt-1 text-xs text-gray-500">
                    ${duplicate.reason}
                  </div>
                </div>
                <button 
                  onclick="viewExistingEvent(${duplicate.id})"
                  class="ml-2 text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200"
                >
                  Voir
                </button>
              </div>
            </div>
          `;
        });

        duplicateList.innerHTML = html;
        suggestionsContainer.classList.remove("hidden");
      }

      // Masquer les suggestions de doublons
      function hideDuplicateSuggestions() {
        const suggestionsContainer = document.getElementById(
          "duplicate-suggestions"
        );
        if (suggestionsContainer) {
          suggestionsContainer.classList.add("hidden");
        }
      }

      // Fonction pour voir un √©v√©nement existant
      function viewExistingEvent(eventId) {
        // Fermer le modal de cr√©ation et ouvrir les d√©tails de l'√©v√©nement
        closeModal();
        // Ici on pourrait ouvrir un modal de d√©tail de l'√©v√©nement ou rediriger
        showNotification(
          "info",
          `Vous pouvez consulter l'√©v√©nement existant dans la liste des √©v√©nements.`
        );
      }

      // Modal de confirmation pour les doublons probables
      function showDuplicateConfirmationModal(duplicates) {
        return new Promise((resolve) => {
          const modal = document.createElement("div");
          modal.className =
            "fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4";

          const topDuplicate = duplicates[0];
          const confidenceIcon = topDuplicate.confidence >= 80 ? "üö®" : "‚ö†Ô∏è";

          modal.innerHTML = `
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-screen overflow-y-auto">
              <div class="flex items-center justify-between p-6 border-b border-red-200 bg-red-50">
                <h2 class="text-xl font-bold text-red-800">
                  ${confidenceIcon} √âv√©nement similaire d√©tect√©
                </h2>
              </div>
              <div class="p-6">
                <div class="mb-4">
                  <p class="text-gray-700 mb-4">
                    Un √©v√©nement tr√®s similaire existe d√©j√†. Voulez-vous vraiment cr√©er ce nouvel √©v√©nement ?
                  </p>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                  <h3 class="text-sm font-medium text-yellow-800 mb-3">√âv√©nement similaire trouv√© :</h3>
                  ${duplicates
                    .slice(0, 2)
                    .map(
                      (duplicate) => `
                    <div class="mb-3 p-3 bg-white rounded border border-yellow-300">
                      <div class="flex items-start justify-between">
                        <div class="flex-1">
                          <div class="flex items-center">
                            <span class="mr-2">${
                              duplicate.confidence >= 80 ? "üö®" : "‚ö†Ô∏è"
                            }</span>
                            <span class="font-medium text-gray-900">${
                              duplicate.title
                            }</span>
                            <span class="ml-2 text-xs text-red-600 font-medium">${
                              duplicate.confidence
                            }% similaire</span>
                          </div>
                          <div class="mt-1 text-sm text-gray-600">
                            üìÖ ${formatEventDate(duplicate.date_start)} ‚Ä¢ üìç ${
                        duplicate.location_city
                      }
                          </div>
                          <div class="mt-1 text-xs text-gray-500">
                            ${duplicate.reason}
                          </div>
                        </div>
                      </div>
                    </div>
                  `
                    )
                    .join("")}
                </div>
                
                <div class="flex justify-end space-x-3">
                  <button 
                    onclick="resolveDuplicateModal(false)"
                    class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
                  >
                    üîÑ Modifier mon √©v√©nement
                  </button>
                  <button 
                    onclick="resolveDuplicateModal(true)"
                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700"
                  >
                    ‚úÖ Cr√©er quand m√™me
                  </button>
                </div>
              </div>
            </div>
          `;

          document.body.appendChild(modal);

          // Ajouter la fonction de r√©solution au window temporairement
          window.resolveDuplicateModal = (confirmed) => {
            document.body.removeChild(modal);
            delete window.resolveDuplicateModal;
            resolve(confirmed);
          };
        });
      }

      async function createNewEvent(event) {
        event.preventDefault();

        if (!currentUser || !authToken) {
          showNotification(
            "error",
            "Connexion requise",
            "Vous devez √™tre connect√© pour cr√©er un √©v√©nement"
          );
          return;
        }

        // V√©rifier les doublons avant cr√©ation
        const title = document.getElementById("event-title").value.trim();
        const dateStart = document.getElementById("event-start").value;
        const city = document.getElementById("event-city").value.trim();

        try {
          const params = new URLSearchParams({ title });
          if (dateStart) params.append("date_start", dateStart);
          if (city) params.append("location_city", city);

          const duplicateResponse = await fetch(
            `${API_BASE}/events/check-duplicates?${params}`
          );

          if (duplicateResponse.ok) {
            const duplicateData = await duplicateResponse.json();
            const highConfidenceDuplicates = duplicateData.duplicates.filter(
              (d) => d.confidence >= 70
            );

            if (highConfidenceDuplicates.length > 0) {
              const confirmed = await showDuplicateConfirmationModal(
                highConfidenceDuplicates
              );
              if (!confirmed) {
                return; // L'utilisateur a annul√©
              }
            }
          }
        } catch (error) {
          console.error(
            "Erreur lors de la v√©rification finale des doublons:",
            error
          );
          // Continuer quand m√™me si l'API √©choue
        }

        // Collecter les URLs des photos
        const photoUrls = [];
        for (let i = 1; i <= 3; i++) {
          const url = document
            .getElementById(`event-photo-url-${i}`)
            .value.trim();
          if (url) {
            photoUrls.push(url);
          }
        }

        // Mettre √† jour selectedPhotoUrls pour la suite du processus
        selectedPhotoUrls = [...photoUrls];

        const formData = {
          title: document.getElementById("event-title").value,
          description: document.getElementById("event-description").value,
          category: document.getElementById("event-category").value,
          locationAddress: document.getElementById("event-address").value,
          locationCity: document.getElementById("event-city").value,
          dateStart: document.getElementById("event-start").value,
          dateEnd: document.getElementById("event-end").value,
          priceAmount:
            parseFloat(document.getElementById("event-price").value) || 0,
          priceIsFree: document.getElementById("event-free").checked,
        };

        console.log("Donn√©es √† envoyer:", formData);

        // V√©rification des doublons d√©sactiv√©e temporairement
        console.log("üìù Cr√©ation d'√©v√©nement sans v√©rification de doublons");

        // Si pas de doublons, cr√©er directement
        await createEventWithPhotos(formData);
      }

      // Cr√©er un √©v√©nement avec photos
      async function createEventWithPhotos(formData) {
        try {
          // Cr√©er d'abord l'√©v√©nement
          const response = await fetch(`${API_BASE}/events`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({ ...formData, action: "create" }),
          });

          console.log("R√©ponse du serveur:", response.status);
          const data = await response.json();
          console.log("Donn√©es re√ßues:", data);

          if (response.ok) {
            // Si des photos ont √©t√© s√©lectionn√©es, les envoyer
            if (selectedPhotoUrls.length > 0) {
              await updateEventPhotos(data.id, selectedPhotoUrls);
            }

            showNotification(
              "success",
              "√âv√©nement cr√©√© !",
              `L'√©v√©nement "${formData.title}" a √©t√© cr√©√© avec succ√®s.`
            );

            // R√©initialiser le formulaire
            document.getElementById("create-event-form").reset();
            document.getElementById("photo-preview").classList.add("hidden");
            selectedPhotoUrls = [];
            // Vider les champs d'URL
            for (let i = 1; i <= 3; i++) {
              document.getElementById(`event-photo-url-${i}`).value = "";
            }

            showSection("events");
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Erreur lors de la cr√©ation de l'√©v√©nement"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Mettre √† jour les photos d'un √©v√©nement avec des URLs
      async function updateEventPhotos(eventId, photoUrls) {
        try {
          console.log(
            "Mise √† jour photos pour eventId:",
            eventId,
            "URLs:",
            photoUrls
          );

          const response = await fetch(`${API_BASE}/events`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${authToken}`,
            },
            body: JSON.stringify({
              action: "update",
              id: eventId,
              photos: photoUrls,
            }),
          });

          if (response.ok) {
            console.log("Photos mises √† jour avec succ√®s");
            // Recharger les √©v√©nements pour afficher les photos
            loadEvents();
          } else {
            const errorData = await response.json();
            console.error(
              "Erreur lors de la mise √† jour des photos:",
              errorData
            );
          }
        } catch (error) {
          console.error("Erreur mise √† jour photos:", error);
        }
      }

      // Noter un √©v√©nement
      function rateEvent(eventId) {
        if (!currentUser || !authToken) {
          showLoginToRateModal();
          return;
        }

        openRatingModal(eventId);
      }

      // Afficher le popup de connexion pour noter
      function showLoginToRateModal() {
        document
          .getElementById("login-to-rate-modal")
          .classList.remove("hidden");
      }

      // Fermer le popup de connexion pour noter
      function closeLoginToRateModal() {
        document.getElementById("login-to-rate-modal").classList.add("hidden");
      }

      // Fonctions pour le modal de notation
      function openRatingModal(eventId) {
        document.getElementById("rating-event-id").value = eventId;
        document.getElementById("rating-modal").classList.remove("hidden");

        // Initialiser le nouveau syst√®me de notation intelligent
        resetRatingForm();

        // Ajouter toutes les m√©thodes de fermeture standard
        setupModalCloseMethods();

        // Scroll automatiquement vers la fen√™tre sur mobile
        if (window.innerWidth <= 768) {
          setTimeout(() => {
            const modal = document.getElementById("rating-modal");
            if (modal) {
              modal.scrollIntoView({
                behavior: "smooth",
                block: "start",
                inline: "nearest",
              });
            }
          }, 100);
        }
      }

      function closeRatingModal() {
        document.getElementById("rating-modal").classList.add("hidden");
        document.getElementById("detailed-rating-form").reset();
        resetRatingForm();
      }

      // Toutes les m√©thodes standard pour fermer le modal
      function setupModalCloseMethods() {
        const modalContent = document.getElementById("rating-modal-content");
        if (!modalContent) return;

        // 1. TOUCHE √âCHAP (ESC)
        const handleKeyPress = (e) => {
          if (e.key === 'Escape') {
            closeRatingModal();
          }
        };
        document.addEventListener('keydown', handleKeyPress);

        // Nettoyer l'event listener quand le modal se ferme
        const originalClose = closeRatingModal;
        closeRatingModal = function() {
          document.removeEventListener('keydown', handleKeyPress);
          originalClose();
        };

        // 2. SWIPE VERS LE BAS (mobile) - plus standard que gauche
        let startY = 0;
        let startX = 0;
        let isSwipeStarted = false;

        // Touch events pour mobile
        modalContent.addEventListener("touchstart", (e) => {
          startY = e.touches[0].clientY;
          startX = e.touches[0].clientX;
          isSwipeStarted = true;
        });

        modalContent.addEventListener("touchmove", (e) => {
          if (!isSwipeStarted) return;
          
          const currentY = e.touches[0].clientY;
          const currentX = e.touches[0].clientX;
          const diffY = currentY - startY; // Vers le bas
          const diffX = Math.abs(currentX - startX);

          // Swipe vers le bas et pas trop horizontal
          if (diffY > 100 && diffX < 100) {
            closeRatingModal();
            isSwipeStarted = false;
          }
        });

        modalContent.addEventListener("touchend", () => {
          isSwipeStarted = false;
        });

        // 3. SWIPE VERS LA GAUCHE (alternative)
        modalContent.addEventListener("touchstart", (e) => {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
        });

        modalContent.addEventListener("touchmove", (e) => {
          if (!isSwipeStarted) return;
          
          const currentX = e.touches[0].clientX;
          const currentY = e.touches[0].clientY;
          const diffX = startX - currentX; // Vers la gauche
          const diffY = Math.abs(startY - currentY);

          // Swipe vers la gauche et pas trop vertical
          if (diffX > 100 && diffY < 100) {
            closeRatingModal();
            isSwipeStarted = false;
          }
        });
      }

      // M√©thodes de fermeture pour le modal "Voir avis"
      function setupRatingsModalCloseMethods() {
        const modalContent = document.getElementById("ratings-modal-content");
        if (!modalContent) return;

        // 1. TOUCHE √âCHAP (ESC)
        const handleKeyPress = (e) => {
          if (e.key === 'Escape') {
            closeRatingsModal();
          }
        };
        document.addEventListener('keydown', handleKeyPress);

        // Nettoyer l'event listener quand le modal se ferme
        const originalClose = closeRatingsModal;
        closeRatingsModal = function() {
          document.removeEventListener('keydown', handleKeyPress);
          originalClose();
        };

        // 2. SWIPE VERS LE BAS (mobile)
        let startY = 0;
        let startX = 0;
        let isSwipeStarted = false;

        modalContent.addEventListener("touchstart", (e) => {
          startY = e.touches[0].clientY;
          startX = e.touches[0].clientX;
          isSwipeStarted = true;
        });

        modalContent.addEventListener("touchmove", (e) => {
          if (!isSwipeStarted) return;
          
          const currentY = e.touches[0].clientY;
          const currentX = e.touches[0].clientX;
          const diffY = currentY - startY; // Vers le bas
          const diffX = Math.abs(currentX - startX);

          // Swipe vers le bas et pas trop horizontal
          if (diffY > 100 && diffX < 100) {
            closeRatingsModal();
            isSwipeStarted = false;
          }
        });

        modalContent.addEventListener("touchend", () => {
          isSwipeStarted = false;
        });
      }

      // M√©thodes de fermeture pour le modal "Modifier √©v√©nement"
      function setupEditEventModalCloseMethods() {
        const modalContent = document.getElementById("edit-event-modal-content");
        if (!modalContent) return;

        // 1. TOUCHE √âCHAP (ESC)
        const handleKeyPress = (e) => {
          if (e.key === 'Escape') {
            closeEditEventModal();
          }
        };
        document.addEventListener('keydown', handleKeyPress);

        // Nettoyer l'event listener quand le modal se ferme
        const originalClose = closeEditEventModal;
        closeEditEventModal = function() {
          document.removeEventListener('keydown', handleKeyPress);
          originalClose();
        };

        // 2. SWIPE VERS LE BAS (mobile)
        let startY = 0;
        let startX = 0;
        let isSwipeStarted = false;

        modalContent.addEventListener("touchstart", (e) => {
          startY = e.touches[0].clientY;
          startX = e.touches[0].clientX;
          isSwipeStarted = true;
        });

        modalContent.addEventListener("touchmove", (e) => {
          if (!isSwipeStarted) return;
          
          const currentY = e.touches[0].clientY;
          const currentX = e.touches[0].clientX;
          const diffY = currentY - startY; // Vers le bas
          const diffX = Math.abs(currentX - startX);

          // Swipe vers le bas et pas trop horizontal
          if (diffY > 100 && diffX < 100) {
            closeEditEventModal();
            isSwipeStarted = false;
          }
        });

        modalContent.addEventListener("touchend", () => {
          isSwipeStarted = false;
        });
      }

      // Fonctions pour le nouveau syst√®me de notation intelligent

      // Variables globales pour les crit√®res
      let selectedTags = [];
      let activeCriteria = {};

      // Variables globales pour la navigation et performance
      let currentPage = 'events'; // Page actuelle
      let pageHistory = ['events']; // Historique des pages
      let isScrolling = false;
      let scrollTimeout = null;

      // Fonctions de navigation et performance
      function setCurrentPage(page) {
        if (currentPage !== page) {
          pageHistory.push(currentPage);
          currentPage = page;
          // Limiter l'historique √† 10 pages
          if (pageHistory.length > 10) {
            pageHistory.shift();
          }
        }
      }

      function goBackToPreviousPage() {
        if (pageHistory.length > 0) {
          const previousPage = pageHistory.pop();
          currentPage = previousPage;
          return previousPage;
        }
        return 'events'; // Fallback
      }

      // Optimisation du scroll avec debouncing
      function optimizeScroll() {
        if (isScrolling) return;
        isScrolling = true;
        
        // D√©sactiver les animations pendant le scroll
        document.body.style.setProperty('--transition-smooth', 'none');
        
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          isScrolling = false;
          // R√©activer les animations apr√®s le scroll
          document.body.style.removeProperty('--transition-smooth');
        }, 150);
      }

      // Intersection Observer pour lazy loading
      function setupLazyLoading() {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target;
              if (img.dataset.src) {
                img.src = img.dataset.src;
                img.removeAttribute('data-src');
                observer.unobserve(img);
              }
            }
          });
        }, {
          rootMargin: '50px 0px',
          threshold: 0.1
        });

        // Observer toutes les images avec data-src
        document.querySelectorAll('img[data-src]').forEach(img => {
          observer.observe(img);
        });
      }

      // Presets de crit√®res par type d'√©v√©nement
      const criteriaPresets = {
        concert: [
          { id: "sound-quality", name: "Qualit√© sonore", icon: "üéµ" },
          { id: "ambiance", name: "Ambiance", icon: "üé≠" },
          { id: "organisation", name: "Organisation", icon: "üìã" },
          { id: "visibility", name: "Visibilit√© sc√®ne", icon: "üëÄ" },
          { id: "comfort", name: "Confort", icon: "ü™ë" },
          { id: "security", name: "S√©curit√©", icon: "üõ°Ô∏è" },
        ],
        conference: [
          { id: "content-quality", name: "Qualit√© contenu", icon: "üìö" },
          { id: "speaker-quality", name: "Qualit√© orateur", icon: "üé§" },
          { id: "organisation", name: "Organisation", icon: "üìã" },
          { id: "comfort", name: "Confort si√®ge", icon: "ü™ë" },
          { id: "accessibility", name: "Accessibilit√©", icon: "‚ôø" },
          { id: "networking", name: "Opportunit√©s r√©seau", icon: "ü§ù" },
        ],
        festival: [
          { id: "ambiance", name: "Ambiance g√©n√©rale", icon: "üé™" },
          { id: "variety", name: "Vari√©t√© activit√©s", icon: "üé®" },
          { id: "food-quality", name: "Qualit√© restauration", icon: "üçî" },
          { id: "organisation", name: "Organisation", icon: "üìã" },
          { id: "cleanliness", name: "Propret√©", icon: "üßπ" },
          { id: "value", name: "Rapport qualit√©/prix", icon: "üí∞" },
        ],
        sport: [
          { id: "game-quality", name: "Qualit√© du match", icon: "‚öΩ" },
          { id: "ambiance", name: "Ambiance stade", icon: "üì¢" },
          { id: "visibility", name: "Visibilit√© terrain", icon: "üëÄ" },
          { id: "facilities", name: "Installations", icon: "üèüÔ∏è" },
          { id: "security", name: "S√©curit√©", icon: "üõ°Ô∏è" },
          { id: "accessibility", name: "Accessibilit√©", icon: "‚ôø" },
        ],
        expo: [
          { id: "content-quality", name: "Qualit√© exposition", icon: "üé®" },
          { id: "organisation", name: "Organisation", icon: "üìã" },
          { id: "accessibility", name: "Accessibilit√©", icon: "‚ôø" },
          { id: "comfort", name: "Confort visite", icon: "üö∂‚Äç‚ôÇÔ∏è" },
          { id: "value", name: "Rapport qualit√©/prix", icon: "üí∞" },
          { id: "learning", name: "Aspect √©ducatif", icon: "üìñ" },
        ],
        custom: [
          { id: "ambiance", name: "Ambiance", icon: "üé≠" },
          { id: "organisation", name: "Organisation", icon: "üìã" },
          { id: "quality", name: "Qualit√© g√©n√©rale", icon: "‚≠ê" },
          { id: "value", name: "Rapport qualit√©/prix", icon: "üí∞" },
          { id: "comfort", name: "Confort", icon: "ü™ë" },
          { id: "accessibility", name: "Accessibilit√©", icon: "‚ôø" },
          { id: "security", name: "S√©curit√©", icon: "üõ°Ô∏è" },
          { id: "cleanliness", name: "Propret√©", icon: "üßπ" },
        ],
      };

      // R√©initialiser le formulaire
      function resetRatingForm() {
        selectedTags = [];
        activeCriteria = {};
        window.editingRatingId = null; // Reset du mode √©dition

        // Masquer les champs d'√©dition en mode cr√©ation
        const eventTitleSection = document.getElementById(
          "event-title-section"
        );
        const eventPhotosSection = document.getElementById(
          "event-photos-section"
        );
        if (eventTitleSection) {
          eventTitleSection.style.display = "none";
        }
        if (eventPhotosSection) {
          eventPhotosSection.style.display = "none";
        }

        document.getElementById("selected-tags").value = "";
        document.getElementById("detailed-criteria").classList.add("hidden");
        document.getElementById("toggle-detailed").textContent =
          "Afficher les crit√®res d√©taill√©s";

        // Reset du titre et bouton du modal
        const modalTitle = document.querySelector("#rating-modal h2");
        if (modalTitle) {
          modalTitle.textContent = "‚≠ê Noter cet √©v√©nement";
        }

        const submitBtn = document.querySelector(
          '#rating-modal button[type="submit"]'
        );
        if (submitBtn) {
          submitBtn.textContent = "Soumettre la notation";
        }

        updateTagButtons();
        updateRatingValue("overall-rating");
        updateCrowdLevel();
      }

      // G√©rer la s√©lection des heures
      function toggleDepartureTime() {
        const stillPresent = document.getElementById("still-present");
        const departureTime = document.getElementById("departure-time");

        if (stillPresent.checked) {
          departureTime.disabled = true;
          departureTime.value = "";
        } else {
          departureTime.disabled = false;
        }
      }

      // G√©rer les boutons de p√©riode
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".time-period-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            document
              .querySelectorAll(".time-period-btn")
              .forEach((b) =>
                b.classList.remove("bg-blue-100", "border-blue-300")
              );
            this.classList.add("bg-blue-100", "border-blue-300");

            // Auto-remplir les heures selon la p√©riode
            const period = this.dataset.period;
            fillTimeFromPeriod(period);
          });
        });
      });

      function fillTimeFromPeriod(period) {
        const arrivalInput = document.getElementById("arrival-time");
        const departureInput = document.getElementById("departure-time");
        const stillPresentCheck = document.getElementById("still-present");

        // R√©initialiser
        stillPresentCheck.checked = false;
        departureInput.disabled = false;

        switch (period) {
          case "debut":
            arrivalInput.value = "14:00";
            departureInput.value = "16:00";
            break;
          case "milieu":
            arrivalInput.value = "18:00";
            departureInput.value = "20:00";
            break;
          case "fin":
            arrivalInput.value = "21:00";
            departureInput.value = "23:00";
            break;
          case "complet":
            arrivalInput.value = "14:00";
            stillPresentCheck.checked = true;
            departureInput.disabled = true;
            departureInput.value = "";
            break;
        }
      }

      // Mettre √† jour la valeur de notation
      function updateRatingValue(sliderId) {
        const slider = document.getElementById(sliderId);
        const valueDisplay = document.getElementById(sliderId + "-value");
        valueDisplay.textContent = parseFloat(slider.value).toFixed(1);
      }

      // Mettre √† jour le niveau de foule
      function updateCrowdLevel() {
        const slider = document.getElementById("crowd-level");
        const textDisplay = document.getElementById("crowd-level-text");
        const value = parseInt(slider.value);

        const levels = [
          "Tr√®s vide",
          "Peu de monde",
          "Mod√©r√©",
          "Bond√©",
          "Tr√®s bond√©",
        ];
        textDisplay.textContent = levels[value - 1];
      }

      // G√©rer les tags rapides
      document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".tag-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const tag = this.dataset.tag;
            if (selectedTags.includes(tag)) {
              selectedTags = selectedTags.filter((t) => t !== tag);
            } else {
              selectedTags.push(tag);
            }
            document.getElementById("selected-tags").value =
              selectedTags.join(",");
            updateTagButtons();
          });
        });
      });

      function updateTagButtons() {
        document.querySelectorAll(".tag-btn").forEach((btn) => {
          const tag = btn.dataset.tag;
          if (selectedTags.includes(tag)) {
            btn.classList.add(
              "bg-blue-100",
              "border-blue-300",
              "text-blue-800"
            );
          } else {
            btn.classList.remove(
              "bg-blue-100",
              "border-blue-300",
              "text-blue-800"
            );
          }
        });
      }

      // Basculer l'affichage des crit√®res d√©taill√©s
      function toggleDetailedCriteria() {
        const detailedSection = document.getElementById("detailed-criteria");
        const toggleBtn = document.getElementById("toggle-detailed");

        if (detailedSection.classList.contains("hidden")) {
          detailedSection.classList.remove("hidden");
          toggleBtn.textContent = "Masquer les crit√®res d√©taill√©s";
          initializeAllCriteria(); // Initialise tous les crit√®res disponibles
        } else {
          detailedSection.classList.add("hidden");
          toggleBtn.textContent = "Afficher les crit√®res d√©taill√©s";
        }
      }

      // Initialiser tous les crit√®res disponibles
      function initializeAllCriteria() {
        const container = document.getElementById("all-criteria-container");
        if (container.children.length > 0) return; // D√©j√† initialis√©

        const allCriteria = [
          { id: "sound-quality", name: "üéµ Qualit√© sonore" },
          { id: "ambiance", name: "üé≠ Ambiance" },
          { id: "organisation", name: "üìã Organisation" },
          { id: "security", name: "üõ°Ô∏è S√©curit√©" },
          { id: "visibility", name: "üëÄ Visibilit√©" },
          { id: "comfort", name: "ü™ë Confort" },
          { id: "accessibility", name: "‚ôø Accessibilit√©" },
          { id: "content-quality", name: "üìö Qualit√© contenu" },
          { id: "speaker-quality", name: "üé§ Orateur" },
          { id: "learning", name: "üìñ √âducatif" },
          { id: "food-quality", name: "üçî Restauration" },
          { id: "cleanliness", name: "üßπ Propret√©" },
          { id: "value", name: "üí∞ Rapport Q/P" },
          { id: "game-quality", name: "‚öΩ Qualit√© match" },
          { id: "facilities", name: "üèüÔ∏è Installations" },
          { id: "networking", name: "ü§ù R√©seau" },
          { id: "variety", name: "üé® Vari√©t√©" },
        ];

        allCriteria.forEach((criterion) => {
          const criterionHtml = `
            <div class="criterion-item" data-criterion="${criterion.id}">
              <label class="flex items-center space-x-2 cursor-pointer p-2 rounded border hover:bg-gray-50">
                <input type="checkbox" class="criterion-checkbox" onchange="toggleCriterionRating('${criterion.id}')">
                <span class="text-sm font-medium">${criterion.name}</span>
              </label>
              <div class="criterion-rating hidden mt-2 pl-6">
                <div class="flex items-center space-x-2">
                  <span class="text-xs text-gray-500">1</span>
                  <input type="range" id="${criterion.id}" min="1" max="5" value="3" class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer" oninput="updateCriterionValue('${criterion.id}')">
                  <span class="text-xs text-gray-500">5</span>
                  <span id="${criterion.id}-value" class="text-sm font-bold text-blue-600 min-w-[2rem]">3</span>
                </div>
              </div>
            </div>
          `;
          container.innerHTML += criterionHtml;
        });
      }

      // Toggle un crit√®re sp√©cifique
      function toggleCriterionRating(criterionId) {
        const checkbox = document.querySelector(
          `[data-criterion="${criterionId}"] .criterion-checkbox`
        );
        const ratingDiv = document.querySelector(
          `[data-criterion="${criterionId}"] .criterion-rating`
        );

        if (checkbox.checked) {
          ratingDiv.classList.remove("hidden");
          activeCriteria[criterionId] = parseInt(
            document.getElementById(criterionId).value
          );
        } else {
          ratingDiv.classList.add("hidden");
          delete activeCriteria[criterionId];
        }
      }

      // Mettre √† jour la valeur d'un crit√®re et l'objet activeCriteria
      function updateCriterionValue(criterionId) {
        const slider = document.getElementById(criterionId);
        const valueSpan = document.getElementById(`${criterionId}-value`);
        const checkbox = document.querySelector(
          `[data-criterion="${criterionId}"] .criterion-checkbox`
        );

        if (slider && valueSpan) {
          valueSpan.textContent = slider.value;

          // Mettre √† jour activeCriteria si le crit√®re est coch√©
          if (checkbox && checkbox.checked) {
            activeCriteria[criterionId] = parseInt(slider.value);
          }
        }
      }

      // Pr√©visualiser une photo en mode √©dition
      function previewEditPhoto(input, index) {
        const preview = document.getElementById(`edit-photo-preview-${index}`);
        if (input.value) {
          preview.innerHTML = `
            <img src="${input.value}"
                 class="w-full h-24 object-cover rounded-md border"
                 onerror="this.style.display='none'"
                 alt="Aper√ßu photo ${index}">
          `;
        } else {
          preview.innerHTML = "";
        }
      }

      // Charger les photos actuelles de l'√©v√©nement
      async function loadCurrentEventPhotos(eventId) {
        try {
          console.log("Chargement photos pour event ID:", eventId);
          const response = await fetch(`${API_BASE}/events/${eventId}`, {
            headers: {
              Authorization: `Bearer ${authToken}`,
              "Content-Type": "application/json",
            },
          });

          console.log("Response status:", response.status);

          if (response.ok) {
            const event = await response.json();
            console.log("Event data received:", event);

            // Les photos peuvent √™tre dans event.photos ou event.data.photos
            const photos = event.photos || event.data?.photos || [];
            console.log("Photos found:", photos);

            // Pr√©-remplir les champs photo
            for (let i = 1; i <= 3; i++) {
              const input = document.getElementById(`edit-photo-url-${i}`);
              const preview = document.getElementById(
                `edit-photo-preview-${i}`
              );

              if (photos[i - 1]) {
                console.log(`Setting photo ${i}:`, photos[i - 1]);
                input.value = photos[i - 1];
                previewEditPhoto(input, i);
              } else {
                input.value = "";
                preview.innerHTML = "";
              }
            }
          } else {
            console.error(
              "Erreur response:",
              response.status,
              response.statusText
            );
          }
        } catch (error) {
          console.error("Erreur chargement photos:", error);
        }
      }

      async function submitDetailedRating(event) {
        event.preventDefault();

        const eventId = document.getElementById("rating-event-id").value;

        // Nouveau syst√®me de donn√©es structur√©es
        const ratingData = {
          action: "create",
          eventId: parseInt(eventId),

          // Note principale
          overallRating: parseFloat(
            document.getElementById("overall-rating").value
          ),

          // Timing de pr√©sence
          presenceTiming: {
            arrivalTime: document.getElementById("arrival-time").value,
            departureTime: document.getElementById("still-present").checked
              ? null
              : document.getElementById("departure-time").value,
            stillPresent: document.getElementById("still-present").checked,
          },

          // Tags rapides s√©lectionn√©s
          quickTags: selectedTags,

          // Crit√®res d√©taill√©s (seulement ceux qui ont √©t√© not√©s)
          detailedCriteria: activeCriteria,

          // Contexte
          contextInfo: {
            crowdLevel: parseInt(document.getElementById("crowd-level").value),
            weatherConditions:
              document.getElementById("weather-conditions").value,
          },

          // Commentaire
          comment: document.getElementById("rating-comment").value,

          // M√©tadonn√©es pour l'analyse
          ratingMetadata: {
            hasDetailedCriteria: Object.keys(activeCriteria).length > 0,
            criteriaCount: Object.keys(activeCriteria).length,
            hasQuickTags: selectedTags.length > 0,
            tagsCount: selectedTags.length,
            submissionTimestamp: new Date().toISOString(),
          },
        };

        try {
          let response, data;

          // Mode √©dition ou cr√©ation ?
          if (window.editingRatingId) {
            // Mode √©dition : PUT request
            response = await fetch(
              `${API_BASE}/ratings/${window.editingRatingId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${authToken}`,
                },
                body: JSON.stringify(ratingData),
              }
            );
          } else {
            // Mode cr√©ation : POST request
            response = await fetch(`${API_BASE}/ratings`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${authToken}`,
              },
              body: JSON.stringify(ratingData),
            });
          }

          data = await response.json();

          if (response.ok) {
            const isEditing = !!window.editingRatingId;
            showNotification(
              "success",
              isEditing ? "Avis modifi√© !" : "Notation enregistr√©e !",
              isEditing
                ? "Votre avis a √©t√© modifi√© avec succ√®s."
                : "Votre avis d√©taill√© a √©t√© enregistr√© avec succ√®s."
            );

            // Nettoyer le mode √©dition
            window.editingRatingId = null;

            closeRatingModal();
            loadEvents(); // Recharger les √©v√©nements pour mettre √† jour les notes

            // Si le modal "Mes avis" est ouvert, le recharger aussi
            if (
              !document
                .getElementById("my-ratings-modal")
                .classList.contains("hidden")
            ) {
              await loadMyRatings();
            }
          } else {
            showNotification(
              "error",
              "Erreur",
              data.error || "Erreur lors de l'enregistrement de la notation"
            );
          }
        } catch (error) {
          console.error("Erreur:", error);
          showNotification("error", "Erreur", "Erreur de connexion au serveur");
        }
      }

      // Gestion de la case "√âv√©nement gratuit"
      document
        .getElementById("event-free")
        .addEventListener("change", function () {
          const priceInput = document.getElementById("event-price");
          if (this.checked) {
            priceInput.value = "0";
            priceInput.disabled = true;
          } else {
            priceInput.disabled = false;
          }
        });

      // Initialisation
      document.addEventListener("DOMContentLoaded", function () {
        // Pr√©-remplir le formulaire de connexion si identifiants sauvegard√©s
        fillLoginForm();

        // V√©rifier s'il y a un token de r√©initialisation dans l'URL
        checkResetPasswordToken();
        
        // Optimiser le scroll global
        let scrollTimeout;
        window.addEventListener('scroll', () => {
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            optimizeScroll();
          }, 10);
        }, { passive: true });

        // D√©marrer le timer d'inactivit√© si d√©j√† connect√©
        if (authToken) {
          resetInactivityTimer();
        }

        // V√©rifier si un token existe d√©j√†
        if (authToken) {
          console.log("Token trouv√©:", authToken);

          // D√©coder le token pour r√©cup√©rer les informations utilisateur
          try {
            const tokenPayload = JSON.parse(atob(authToken.split(".")[1]));
            currentUser = {
              id: tokenPayload.userId,
              username: tokenPayload.username,
            };

            console.log("Utilisateur r√©cup√©r√© du token:", currentUser);
          } catch (error) {
            console.error("Erreur d√©codage token:", error);
            // Token invalide, le supprimer
            localStorage.removeItem("authToken");
            authToken = null;
          }
        }

        updateNavigation();
        loadEvents();
      });
    </script>
  </body>
</html>
